import{w as at,Z as F,H as mt,Y as nt,C as J,i as oe,O as Je,P as Ft,x as Rr,e as Ye,S as Ne,F as jr,J as Xe,r as C,B as A,q as wt,L as _t,M as G,a as qe,b as I,f as Ht,c as Ze,g as Dt,U as R,h as W,d as K,W as bt,G as Qt,j as zr,k as Ke,l as Hr,m as Gr,n as vt,o as Vr,I as $r,p as Ie,s as ht,v as Le,t as Qe,u as Oe,y as Gt,z as ie}from"./@tensorflow-4a9c595e.js";import{_ as E,a as Ct,b as H,c as w,d as x}from"./tslib-890ecb0d.js";var Et=function(){function r(t,e){if(!gt(t)||!gt(e))throw new Error("Dimensions.constructor - expected width and height to be valid numbers, instead have "+JSON.stringify({width:t,height:e}));this._width=t,this._height=e}return Object.defineProperty(r.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),r.prototype.reverse=function(){return new r(1/this.width,1/this.height)},r}();function Vt(r,t){return r instanceof at&&r.shape.length===t}function Ur(r){return Vt(r,2)}function $t(r){return Vt(r,3)}function ft(r){return Vt(r,4)}function Jr(r){return r%1!==0}function We(r){return r%2===0}function Yr(r,t){t===void 0&&(t=2);var e=Math.pow(10,t);return Math.floor(r*e)/e}function Re(r){return r&&r.width&&r.height}function Xr(r,t){var e=r.width,n=r.height,a=t/Math.max(n,e);return new Et(Math.round(e*a),Math.round(n*a))}function ce(r){return r.reduce(function(t,e){return t.add(e)},new T(0,0)).div(new T(r.length,r.length))}function Tt(r,t,e){return Array(r).fill(0).map(function(n,a){return t+a*e})}function gt(r){return!!r&&r!==1/0&&r!==-1/0&&!isNaN(r)||r===0}function je(r){return gt(r)&&0<=r&&r<=1}var T=function(){function r(t,e){this._x=t,this._y=e}return Object.defineProperty(r.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),r.prototype.add=function(t){return new r(this.x+t.x,this.y+t.y)},r.prototype.sub=function(t){return new r(this.x-t.x,this.y-t.y)},r.prototype.mul=function(t){return new r(this.x*t.x,this.y*t.y)},r.prototype.div=function(t){return new r(this.x/t.x,this.y/t.y)},r.prototype.abs=function(){return new r(Math.abs(this.x),Math.abs(this.y))},r.prototype.magnitude=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))},r.prototype.floor=function(){return new r(Math.floor(this.x),Math.floor(this.y))},r}(),lt=function(){function r(t,e){e===void 0&&(e=!0);var n=t||{},a=[n.left,n.top,n.right,n.bottom].every(gt),o=[n.x,n.y,n.width,n.height].every(gt);if(!o&&!a)throw new Error("Box.constructor - expected box to be IBoundingBox | IRect, instead have "+JSON.stringify(n));var c=o?[n.x,n.y,n.width,n.height]:[n.left,n.top,n.right-n.left,n.bottom-n.top],i=c[0],s=c[1],u=c[2],h=c[3];r.assertIsValidBox({x:i,y:s,width:u,height:h},"Box.constructor",e),this._x=i,this._y=s,this._width=u,this._height=h}return r.isRect=function(t){return!!t&&[t.x,t.y,t.width,t.height].every(gt)},r.assertIsValidBox=function(t,e,n){if(n===void 0&&(n=!1),!r.isRect(t))throw new Error(e+" - invalid box: "+JSON.stringify(t)+", expected object with properties x, y, width, height");if(!n&&(t.width<0||t.height<0))throw new Error(e+" - width ("+t.width+") and height ("+t.height+") must be positive numbers")},Object.defineProperty(r.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"left",{get:function(){return this.x},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"top",{get:function(){return this.y},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"area",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"topLeft",{get:function(){return new T(this.left,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"topRight",{get:function(){return new T(this.right,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"bottomLeft",{get:function(){return new T(this.left,this.bottom)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"bottomRight",{get:function(){return new T(this.right,this.bottom)},enumerable:!0,configurable:!0}),r.prototype.round=function(){var t=[this.x,this.y,this.width,this.height].map(function(c){return Math.round(c)}),e=t[0],n=t[1],a=t[2],o=t[3];return new r({x:e,y:n,width:a,height:o})},r.prototype.floor=function(){var t=[this.x,this.y,this.width,this.height].map(function(c){return Math.floor(c)}),e=t[0],n=t[1],a=t[2],o=t[3];return new r({x:e,y:n,width:a,height:o})},r.prototype.toSquare=function(){var t=this,e=t.x,n=t.y,a=t.width,o=t.height,c=Math.abs(a-o);return a<o&&(e-=c/2,a+=c),o<a&&(n-=c/2,o+=c),new r({x:e,y:n,width:a,height:o})},r.prototype.rescale=function(t){var e=Re(t)?t.width:t,n=Re(t)?t.height:t;return new r({x:this.x*e,y:this.y*n,width:this.width*e,height:this.height*n})},r.prototype.pad=function(t,e){var n=[this.x-t/2,this.y-e/2,this.width+t,this.height+e],a=n[0],o=n[1],c=n[2],i=n[3];return new r({x:a,y:o,width:c,height:i})},r.prototype.clipAtImageBorders=function(t,e){var n=this,a=n.x,o=n.y,c=n.right,i=n.bottom,s=Math.max(a,0),u=Math.max(o,0),h=c-s,v=i-u,f=Math.min(h,t-s),l=Math.min(v,e-u);return new r({x:s,y:u,width:f,height:l}).floor()},r.prototype.shift=function(t,e){var n=this,a=n.width,o=n.height,c=this.x+t,i=this.y+e;return new r({x:c,y:i,width:a,height:o})},r.prototype.padAtBorders=function(t,e){var n=this.width+1,a=this.height+1,o=1,c=1,i=n,s=a,u=this.left,h=this.top,v=this.right,f=this.bottom;return v>e&&(i=-v+e+n,v=e),f>t&&(s=-f+t+a,f=t),u<1&&(s=2-u,u=1),h<1&&(s=2-h,h=1),{dy:c,edy:s,dx:o,edx:i,y:h,ey:f,x:u,ex:v,w:n,h:a}},r.prototype.calibrate=function(t){return new r({left:this.left+t.left*this.width,top:this.top+t.top*this.height,right:this.right+t.right*this.width,bottom:this.bottom+t.bottom*this.height}).toSquare().round()},r}(),Ut=function(r){E(t,r);function t(e,n,a,o,c){return c===void 0&&(c=!1),r.call(this,{left:e,top:n,right:a,bottom:o},c)||this}return t}(lt),tr=function(){function r(t,e,n,a,o){this._imageDims=new Et(o.width,o.height),this._score=t,this._classScore=e,this._className=n,this._box=new lt(a).rescale(this._imageDims)}return Object.defineProperty(r.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"className",{get:function(){return this._className},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"box",{get:function(){return this._box},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageDims",{get:function(){return this._imageDims},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageWidth",{get:function(){return this.imageDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageHeight",{get:function(){return this.imageDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"relativeBox",{get:function(){return new lt(this._box).rescale(this.imageDims.reverse())},enumerable:!0,configurable:!0}),r.prototype.forSize=function(t,e){return new r(this.score,this.classScore,this.className,this.relativeBox,{width:t,height:e})},r}(),tt=function(r){E(t,r);function t(e,n,a){return r.call(this,e,e,"",n,a)||this}return t.prototype.forSize=function(e,n){var a=r.prototype.forSize.call(this,e,n),o=a.score,c=a.relativeBox,i=a.imageDims;return new t(o,c,i)},t}(tr);function qr(r,t,e){e===void 0&&(e=!0);var n=Math.max(0,Math.min(r.right,t.right)-Math.max(r.left,t.left)),a=Math.max(0,Math.min(r.bottom,t.bottom)-Math.max(r.top,t.top)),o=n*a;return e?o/(r.area+t.area-o):o/Math.min(r.area,t.area)}function Zr(r){var t=r.map(function(i){return i.x}),e=r.map(function(i){return i.y}),n=t.reduce(function(i,s){return s<i?s:i},1/0),a=e.reduce(function(i,s){return s<i?s:i},1/0),o=t.reduce(function(i,s){return i<s?s:i},0),c=e.reduce(function(i,s){return i<s?s:i},0);return new Ut(n,a,o,c)}function St(r,t,e,n){n===void 0&&(n=!0);for(var a=t.map(function(i,s){return{score:i,boxIndex:s}}).sort(function(i,s){return i.score-s.score}).map(function(i){return i.boxIndex}),o=[],c=function(){var i=a.pop();o.push(i);for(var s=a,u=[],h=0;h<s.length;h++){var v=s[h],f=r[i],l=r[v];u.push(qr(f,l,n))}a=a.filter(function(p,m){return u[m]<=e})};a.length>0;)c();return o}function Bt(r,t){return F(function(){var e=t[0],n=t[1],a=t[2],o=mt(Ct(r.shape.slice(0,3),[1]),e),c=mt(Ct(r.shape.slice(0,3),[1]),n),i=mt(Ct(r.shape.slice(0,3),[1]),a),s=nt([o,c,i],3);return J(r,s)})}function Kr(r,t){return t===void 0&&(t=!1),F(function(){var e=r.shape.slice(1),n=e[0],a=e[1];if(n===a)return r;var o=Math.abs(n-a),c=Math.round(o*(t?.5:1)),i=n>a?2:1,s=function(l){var p=r.shape.slice();return p[i]=l,mt(p,0)},u=s(c),h=o-u.shape[i],v=t&&h?s(h):null,f=[v,r,u].filter(function(l){return!!l}).map(function(l){return l.toFloat()});return nt(f,i)})}function te(r){return 1/(1+Math.exp(-r))}var se=function(r){E(t,r);function t(e,n,a,o,c){return c===void 0&&(c=!1),r.call(this,{x:e,y:n,width:a,height:o},c)||this}return t}(lt),Qr=.5,tn=.43,en=.45,Wt=function(){function r(t,e,n){n===void 0&&(n=new T(0,0));var a=e.width,o=e.height;this._imgDims=new Et(a,o),this._shift=n,this._positions=t.map(function(c){return c.mul(new T(a,o)).add(n)})}return Object.defineProperty(r.prototype,"shift",{get:function(){return new T(this._shift.x,this._shift.y)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageWidth",{get:function(){return this._imgDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageHeight",{get:function(){return this._imgDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"positions",{get:function(){return this._positions},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"relativePositions",{get:function(){var t=this;return this._positions.map(function(e){return e.sub(t._shift).div(new T(t.imageWidth,t.imageHeight))})},enumerable:!0,configurable:!0}),r.prototype.forSize=function(t,e){return new this.constructor(this.relativePositions,{width:t,height:e})},r.prototype.shiftBy=function(t,e){return new this.constructor(this.relativePositions,this._imgDims,new T(t,e))},r.prototype.shiftByPoint=function(t){return this.shiftBy(t.x,t.y)},r.prototype.align=function(t,e){if(e===void 0&&(e={}),t){var n=t instanceof tt?t.box.floor():new lt(t);return this.shiftBy(n.x,n.y).align(null,e)}var a=Object.assign({},{useDlibAlignment:!1,minBoxPadding:.2},e),o=a.useDlibAlignment,c=a.minBoxPadding;return o?this.alignDlib():this.alignMinBbox(c)},r.prototype.alignDlib=function(){var t=this.getRefPointsForAlignment(),e=t[0],n=t[1],a=t[2],o=function(v){return a.sub(v).magnitude()},c=(o(e)+o(n))/2,i=Math.floor(c/en),s=ce(t),u=Math.floor(Math.max(0,s.x-Qr*i)),h=Math.floor(Math.max(0,s.y-tn*i));return new se(u,h,Math.min(i,this.imageWidth+u),Math.min(i,this.imageHeight+h))},r.prototype.alignMinBbox=function(t){var e=Zr(this.positions);return e.pad(e.width*t,e.height*t)},r.prototype.getRefPointsForAlignment=function(){throw new Error("getRefPointsForAlignment not implemented by base class")},r}(),rn=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.getRefPointsForAlignment=function(){var e=this.positions;return[e[0],e[1],ce([e[3],e[4]])]},t}(Wt),nn=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.getJawOutline=function(){return this.positions.slice(0,17)},t.prototype.getLeftEyeBrow=function(){return this.positions.slice(17,22)},t.prototype.getRightEyeBrow=function(){return this.positions.slice(22,27)},t.prototype.getNose=function(){return this.positions.slice(27,36)},t.prototype.getLeftEye=function(){return this.positions.slice(36,42)},t.prototype.getRightEye=function(){return this.positions.slice(42,48)},t.prototype.getMouth=function(){return this.positions.slice(48,68)},t.prototype.getRefPointsForAlignment=function(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(ce)},t}(Wt),ze=function(){function r(t,e){this._label=t,this._distance=e}return Object.defineProperty(r.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"distance",{get:function(){return this._distance},enumerable:!0,configurable:!0}),r.prototype.toString=function(t){return t===void 0&&(t=!0),""+this.label+(t?" ("+Yr(this.distance)+")":"")},r}(),He=function(r){E(t,r);function t(e,n){var a=r.call(this,e)||this;return a._label=n,a}return t.assertIsValidLabeledBox=function(e,n){if(lt.assertIsValidBox(e,n),!gt(e.label))throw new Error(n+" - expected property label ("+e.label+") to be a number")},Object.defineProperty(t.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),t}(lt),kt=function(){function r(t,e){if(typeof t!="string")throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(e)||e.some(function(n){return!(n instanceof Float32Array)}))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=t,this._descriptors=e}return Object.defineProperty(r.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"descriptors",{get:function(){return this._descriptors},enumerable:!0,configurable:!0}),r.prototype.toJSON=function(){return{label:this.label,descriptors:this.descriptors.map(function(t){return Array.from(t)})}},r.fromJSON=function(t){var e=t.descriptors.map(function(n){return new Float32Array(n)});return new r(t.label,e)},r}();(function(r){E(t,r);function t(e,n,a,o){var c=r.call(this,e,n)||this;return c._score=a,c._classScore=o,c}return t.assertIsValidPredictedBox=function(e,n){if(He.assertIsValidLabeledBox(e,n),!je(e.score)||!je(e.classScore))throw new Error(n+" - expected properties score ("+e.score+") and ("+e.classScore+") to be a number between [0, 1]")},Object.defineProperty(t.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),t})(He);function an(r){return r.detection instanceof tt}function ue(r,t){var e={detection:t};return Object.assign({},r,e)}function er(){var r=window.fetch||function(){throw new Error("fetch - missing fetch implementation for browser environment")},t=function(){throw new Error("readFile - filesystem not available for browser environment")};return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D,Image:HTMLImageElement,ImageData,Video:HTMLVideoElement,createCanvasElement:function(){return document.createElement("canvas")},createImageElement:function(){return document.createElement("img")},fetch:r,readFile:t}}function rr(r){var t="";if(!r)try{r=require("fs")}catch(n){t=n.toString()}var e=r?function(n){return new Promise(function(a,o){r.readFile(n,function(c,i){return c?o(c):a(i)})})}:function(){throw new Error("readFile - failed to require fs in nodejs environment with error: "+t)};return{readFile:e}}function nr(){var r=global.Canvas||global.HTMLCanvasElement,t=global.Image||global.HTMLImageElement,e=function(){if(r)return new r;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")},n=function(){if(t)return new t;throw new Error("createImageElement - missing Image implementation for nodejs environment")},a=global.fetch||function(){throw new Error("fetch - missing fetch implementation for nodejs environment")},o=rr();return H({Canvas:r||function(){function c(){}return c}(),CanvasRenderingContext2D:global.CanvasRenderingContext2D||function(){function c(){}return c}(),Image:t||function(){function c(){}return c}(),ImageData:global.ImageData||function(){function c(){}return c}(),Video:global.HTMLVideoElement||function(){function c(){}return c}(),createCanvasElement:e,createImageElement:n,fetch:a},o)}function ar(){return typeof window=="object"&&typeof document<"u"&&typeof HTMLImageElement<"u"&&typeof HTMLCanvasElement<"u"&&typeof HTMLVideoElement<"u"&&typeof ImageData<"u"&&typeof CanvasRenderingContext2D<"u"}function or(){return typeof global=="object"&&typeof require=="function"&&typeof module<"u"&&typeof process<"u"&&!!process.version}var N;function on(){if(!N)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return N}function ne(r){N=r}function he(){ar()&&ne(er()),or()&&ne(nr())}function cn(r){if(N||he(),!N)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");var t=r.Canvas,e=t===void 0?N.Canvas:t,n=r.Image,a=n===void 0?N.Image:n;N.Canvas=e,N.Image=a,N.createCanvasElement=r.createCanvasElement||function(){return new e},N.createImageElement=r.createImageElement||function(){return new a},N.ImageData=r.ImageData||N.ImageData,N.Video=r.Video||N.Video,N.fetch=r.fetch||N.fetch,N.readFile=r.readFile||N.readFile}var j={getEnv:on,setEnv:ne,initialize:he,createBrowserEnv:er,createFileSystem:rr,createNodejsEnv:nr,monkeyPatch:cn,isBrowser:ar,isNodejs:or};he();function ir(r){return!j.isNodejs()&&typeof r=="string"?document.getElementById(r):r}function yt(r){var t=j.getEnv(),e=t.Canvas,n=t.CanvasRenderingContext2D;if(r instanceof n)return r;var a=ir(r);if(!(a instanceof e))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");var o=a.getContext("2d");if(!o)throw new Error("resolveContext2d - canvas 2d context is null");return o}var Ge;(function(r){r.TOP_LEFT="TOP_LEFT",r.TOP_RIGHT="TOP_RIGHT",r.BOTTOM_LEFT="BOTTOM_LEFT",r.BOTTOM_RIGHT="BOTTOM_RIGHT"})(Ge||(Ge={}));function cr(r){var t=j.getEnv(),e=t.Image,n=t.Video;return r instanceof e&&r.complete||r instanceof n&&r.readyState>=3}function sn(r){return new Promise(function(t,e){if(r instanceof j.getEnv().Canvas||cr(r))return t();function n(o){o.currentTarget&&(o.currentTarget.removeEventListener("load",n),o.currentTarget.removeEventListener("error",a),t(o))}function a(o){o.currentTarget&&(o.currentTarget.removeEventListener("load",n),o.currentTarget.removeEventListener("error",a),e(o))}r.addEventListener("load",n),r.addEventListener("error",a)})}function sr(r){var t=j.getEnv(),e=t.Image,n=t.Video;return r instanceof e?new Et(r.naturalWidth,r.naturalHeight):r instanceof n?new Et(r.videoWidth,r.videoHeight):new Et(r.width,r.height)}function Jt(r){var t=r.width,e=r.height,n=j.getEnv().createCanvasElement,a=n();return a.width=t,a.height=e,a}function ve(r,t){var e=j.getEnv().ImageData;if(!(r instanceof e)&&!cr(r))throw new Error("createCanvasFromMedia - media has not finished loading yet");var n=t||sr(r),a=n.width,o=n.height,c=Jt({width:a,height:o});return r instanceof e?yt(c).putImageData(r,0,0):yt(c).drawImage(r,0,0,a,o),c}function un(r,t){return w(this,void 0,void 0,function(){var e,n,a,o,c,i;return x(this,function(s){switch(s.label){case 0:return e=t||j.getEnv().createCanvasElement(),n=r.shape.slice(ft(r)?1:0),a=n[0],o=n[1],c=n[2],i=F(function(){return r.as3D(a,o,c).toInt()}),[4,oe.toPixels(i,e)];case 1:return s.sent(),i.dispose(),[2,e]}})})}function Ve(r){var t=j.getEnv(),e=t.Image,n=t.Canvas,a=t.Video;return r instanceof e||r instanceof n||r instanceof a}function hn(r,t,e){e===void 0&&(e=!1);var n=j.getEnv(),a=n.Image,o=n.Canvas;if(!(r instanceof a||r instanceof o))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");var c=sr(r),i=t/Math.max(c.height,c.width),s=i*c.width,u=i*c.height,h=Jt({width:t,height:t}),v=r instanceof o?r:ve(r),f=Math.abs(s-u)/2,l=e&&s<u?f:0,p=e&&u<s?f:0;return yt(h).drawImage(v,l,p,s,u),h}var Rt=function(){function r(t,e){var n=this;if(e===void 0&&(e=!1),this._imageTensors=[],this._canvases=[],this._treatAsBatchInput=!1,this._inputDimensions=[],!Array.isArray(t))throw new Error("NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have "+t);this._treatAsBatchInput=e,this._batchSize=t.length,t.forEach(function(a,o){if($t(a)){n._imageTensors[o]=a,n._inputDimensions[o]=a.shape;return}if(ft(a)){var c=a.shape[0];if(c!==1)throw new Error("NetInput - tf.Tensor4D with batchSize "+c+" passed, but not supported in input array");n._imageTensors[o]=a,n._inputDimensions[o]=a.shape.slice(1);return}var i=a instanceof j.getEnv().Canvas?a:ve(a);n._canvases[o]=i,n._inputDimensions[o]=[i.height,i.width,3]})}return Object.defineProperty(r.prototype,"imageTensors",{get:function(){return this._imageTensors},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"canvases",{get:function(){return this._canvases},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isBatchInput",{get:function(){return this.batchSize>1||this._treatAsBatchInput},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"batchSize",{get:function(){return this._batchSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"inputDimensions",{get:function(){return this._inputDimensions},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"reshapedInputDimensions",{get:function(){var t=this;return Tt(this.batchSize,0,1).map(function(e,n){return t.getReshapedInputDimensions(n)})},enumerable:!0,configurable:!0}),r.prototype.getInput=function(t){return this.canvases[t]||this.imageTensors[t]},r.prototype.getInputDimensions=function(t){return this._inputDimensions[t]},r.prototype.getInputHeight=function(t){return this._inputDimensions[t][0]},r.prototype.getInputWidth=function(t){return this._inputDimensions[t][1]},r.prototype.getReshapedInputDimensions=function(t){if(typeof this.inputSize!="number")throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");var e=this.getInputWidth(t),n=this.getInputHeight(t);return Xr({width:e,height:n},this.inputSize)},r.prototype.toBatchTensor=function(t,e){var n=this;return e===void 0&&(e=!0),this._inputSize=t,F(function(){var a=Tt(n.batchSize,0,1).map(function(c){var i=n.getInput(c);if(i instanceof at){var s=ft(i)?i:i.expandDims();return s=Kr(s,e),(s.shape[1]!==t||s.shape[2]!==t)&&(s=Je.resizeBilinear(s,[t,t])),s.as3D(t,t,3)}if(i instanceof j.getEnv().Canvas)return oe.fromPixels(hn(i,t,e));throw new Error("toBatchTensor - at batchIdx "+c+", expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have "+i)}),o=Ft(a.map(function(c){return c.toFloat()})).as4D(n.batchSize,t,t,3);return o})},r}();function O(r){return w(this,void 0,void 0,function(){var t,e,n;return x(this,function(a){switch(a.label){case 0:if(r instanceof Rt)return[2,r];if(t=Array.isArray(r)?r:[r],!t.length)throw new Error("toNetInput - empty array passed as input");return e=function(o){return Array.isArray(r)?" at input index "+o+":":""},n=t.map(ir),n.forEach(function(o,c){if(!Ve(o)&&!$t(o)&&!ft(o))throw typeof t[c]=="string"?new Error("toNetInput -"+e(c)+" string passed, but could not resolve HTMLElement for element id "+t[c]):new Error("toNetInput -"+e(c)+" expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id");if(ft(o)){var i=o.shape[0];if(i!==1)throw new Error("toNetInput -"+e(c)+" tf.Tensor4D with batchSize "+i+" passed, but not supported in input array")}}),[4,Promise.all(n.map(function(o){return Ve(o)&&sn(o)}))];case 1:return a.sent(),[2,new Rt(n,Array.isArray(r))]}})})}function fe(r,t){return w(this,void 0,void 0,function(){var e,n,a,o,c,i,s;return x(this,function(u){switch(u.label){case 0:return e=j.getEnv().Canvas,n=r,r instanceof e?[3,5]:[4,O(r)];case 1:if(a=u.sent(),a.batchSize>1)throw new Error("extractFaces - batchSize > 1 not supported");return o=a.getInput(0),o instanceof e?(c=o,[3,4]):[3,2];case 2:return[4,un(o)];case 3:c=u.sent(),u.label=4;case 4:n=c,u.label=5;case 5:return i=yt(n),s=t.map(function(h){return h instanceof tt?h.forSize(n.width,n.height).box.floor():h}).map(function(h){return h.clipAtImageBorders(n.width,n.height)}),[2,s.map(function(h){var v=h.x,f=h.y,l=h.width,p=h.height,m=Jt({width:l,height:p});return yt(m).putImageData(i.getImageData(v,f,l,p),0,0),m})]}})})}function le(r,t){return w(this,void 0,void 0,function(){return x(this,function(e){if(!$t(r)&&!ft(r))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(ft(r)&&r.shape[0]>1)throw new Error("extractFaceTensors - batchSize > 1 not supported");return[2,F(function(){var n=r.shape.slice(ft(r)?1:0),a=n[0],o=n[1],c=n[2],i=t.map(function(u){return u instanceof tt?u.forSize(o,a).box:u}).map(function(u){return u.clipAtImageBorders(o,a)}),s=i.map(function(u){var h=u.x,v=u.y,f=u.width,l=u.height;return Rr(r.as3D(a,o,c),[v,h,0],[l,f,c])});return s})]})})}function vn(r,t){return w(this,void 0,void 0,function(){var e,n;return x(this,function(a){switch(a.label){case 0:return e=j.getEnv().fetch,[4,e(r,t)];case 1:if(n=a.sent(),!(n.status<400))throw new Error("failed to fetch: ("+n.status+") "+n.statusText+", from url: "+n.url);return[2,n]}})})}function fn(r){return w(this,void 0,void 0,function(){return x(this,function(t){switch(t.label){case 0:return[4,vn(r)];case 1:return[2,t.sent().json()]}})})}function ur(r,t){var e=t+"-weights_manifest.json";if(!r)return{modelBaseUri:"",manifestUri:e};if(r==="/")return{modelBaseUri:"/",manifestUri:"/"+e};var n=r.startsWith("http://")?"http://":r.startsWith("https://")?"https://":"";r=r.replace(n,"");var a=r.split("/").filter(function(i){return i}),o=r.endsWith(".json")?a[a.length-1]:e,c=n+(r.endsWith(".json")?a.slice(0,a.length-1):a).join("/");return c=r.startsWith("/")?"/"+c:c,{modelBaseUri:c,manifestUri:c==="/"?"/"+o:c+"/"+o}}function ln(r,t){return w(this,void 0,void 0,function(){var e,n,a,o;return x(this,function(c){switch(c.label){case 0:return e=ur(r,t),n=e.manifestUri,a=e.modelBaseUri,[4,fn(n)];case 1:return o=c.sent(),[2,Ye.loadWeights(o,a)]}})})}var ot=function(){function r(t){this._name=t,this._params=void 0,this._paramMappings=[]}return Object.defineProperty(r.prototype,"params",{get:function(){return this._params},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"paramMappings",{get:function(){return this._paramMappings},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isLoaded",{get:function(){return!!this.params},enumerable:!0,configurable:!0}),r.prototype.getParamFromPath=function(t){var e=this.traversePropertyPath(t),n=e.obj,a=e.objProp;return n[a]},r.prototype.reassignParamFromPath=function(t,e){var n=this.traversePropertyPath(t),a=n.obj,o=n.objProp;a[o].dispose(),a[o]=e},r.prototype.getParamList=function(){var t=this;return this._paramMappings.map(function(e){var n=e.paramPath;return{path:n,tensor:t.getParamFromPath(n)}})},r.prototype.getTrainableParams=function(){return this.getParamList().filter(function(t){return t.tensor instanceof Ne})},r.prototype.getFrozenParams=function(){return this.getParamList().filter(function(t){return!(t.tensor instanceof Ne)})},r.prototype.variable=function(){var t=this;this.getFrozenParams().forEach(function(e){var n=e.path,a=e.tensor;t.reassignParamFromPath(n,a.variable())})},r.prototype.freeze=function(){var t=this;this.getTrainableParams().forEach(function(e){var n=e.path,a=e.tensor,o=jr(a.dataSync());a.dispose(),t.reassignParamFromPath(n,o)})},r.prototype.dispose=function(t){t===void 0&&(t=!0),this.getParamList().forEach(function(e){if(t&&e.tensor.isDisposed)throw new Error("param tensor has already been disposed for path "+e.path);e.tensor.dispose()}),this._params=void 0},r.prototype.serializeParams=function(){return new Float32Array(this.getParamList().map(function(t){var e=t.tensor;return Array.from(e.dataSync())}).reduce(function(t,e){return t.concat(e)}))},r.prototype.load=function(t){return w(this,void 0,void 0,function(){return x(this,function(e){switch(e.label){case 0:return t instanceof Float32Array?(this.extractWeights(t),[2]):[4,this.loadFromUri(t)];case 1:return e.sent(),[2]}})})},r.prototype.loadFromUri=function(t){return w(this,void 0,void 0,function(){var e;return x(this,function(n){switch(n.label){case 0:if(t&&typeof t!="string")throw new Error(this._name+".loadFromUri - expected model uri");return[4,ln(t,this.getDefaultModelName())];case 1:return e=n.sent(),this.loadFromWeightMap(e),[2]}})})},r.prototype.loadFromDisk=function(t){return w(this,void 0,void 0,function(){var e,n,a,o,c,i,s,u,h,v;return x(this,function(f){switch(f.label){case 0:if(t&&typeof t!="string")throw new Error(this._name+".loadFromDisk - expected model file path");return e=j.getEnv().readFile,n=ur(t,this.getDefaultModelName()),a=n.manifestUri,o=n.modelBaseUri,c=function(l){return Promise.all(l.map(function(p){return e(p).then(function(m){return m.buffer})}))},i=Ye.weightsLoaderFactory(c),h=(u=JSON).parse,[4,e(a)];case 1:return s=h.apply(u,[f.sent().toString()]),[4,i(s,o)];case 2:return v=f.sent(),this.loadFromWeightMap(v),[2]}})})},r.prototype.loadFromWeightMap=function(t){var e=this.extractParamsFromWeigthMap(t),n=e.paramMappings,a=e.params;this._paramMappings=n,this._params=a},r.prototype.extractWeights=function(t){var e=this.extractParams(t),n=e.paramMappings,a=e.params;this._paramMappings=n,this._params=a},r.prototype.traversePropertyPath=function(t){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");var e=t.split("/").reduce(function(o,c){if(!o.nextObj.hasOwnProperty(c))throw new Error("traversePropertyPath - object does not have property "+c+", for path "+t);return{obj:o.nextObj,objProp:c,nextObj:o.nextObj[c]}},{nextObj:this.params}),n=e.obj,a=e.objProp;if(!n||!a||!(n[a]instanceof at))throw new Error("traversePropertyPath - parameter is not a tensor, for path "+t);return{obj:n,objProp:a}},r}();function V(r,t,e){return F(function(){var n=Xe(r,t.depthwise_filter,t.pointwise_filter,e,"same");return n=C(n,t.bias),n})}function ee(r,t,e){return e===void 0&&(e=!1),F(function(){var n=A(e?C(wt(r,t.conv0.filters,[2,2],"same"),t.conv0.bias):V(r,t.conv0,[2,2])),a=V(n,t.conv1,[1,1]),o=A(C(n,a)),c=V(o,t.conv2,[1,1]);return A(C(n,C(a,c)))})}function Nt(r,t,e,n){return e===void 0&&(e=!1),n===void 0&&(n=!0),F(function(){var a=A(e?C(wt(r,t.conv0.filters,n?[2,2]:[1,1],"same"),t.conv0.bias):V(r,t.conv0,n?[2,2]:[1,1])),o=V(a,t.conv1,[1,1]),c=A(C(a,o)),i=V(c,t.conv2,[1,1]),s=A(C(a,C(o,i))),u=V(s,t.conv3,[1,1]);return A(C(a,C(o,C(i,u))))})}function X(r,t,e,n){return e===void 0&&(e="same"),n===void 0&&(n=!1),F(function(){var a=C(wt(r,t.filters,[1,1],e),t.bias);return n?A(a):a})}function it(r,t){Object.keys(r).forEach(function(e){t.some(function(n){return n.originalPath===e})||r[e].dispose()})}function Yt(r,t){return function(e,n,a,o){var c=_t(r(e*n*a*a),[a,a,e,n]),i=G(r(n));return t.push({paramPath:o+"/filters"},{paramPath:o+"/bias"}),{filters:c,bias:i}}}function pe(r,t){return function(e,n,a){var o=qe(r(e*n),[e,n]),c=G(r(n));return t.push({paramPath:a+"/weights"},{paramPath:a+"/bias"}),{weights:o,bias:c}}}var hr=function(){function r(t,e,n){this.depthwise_filter=t,this.pointwise_filter=e,this.bias=n}return r}();function de(r,t){return function(e,n,a){var o=_t(r(9*e),[3,3,e,1]),c=_t(r(e*n),[1,1,e,n]),i=G(r(n));return t.push({paramPath:a+"/depthwise_filter"},{paramPath:a+"/pointwise_filter"},{paramPath:a+"/bias"}),new hr(o,c,i)}}function me(r){return function(t){var e=r(t+"/depthwise_filter",4),n=r(t+"/pointwise_filter",4),a=r(t+"/bias",1);return new hr(e,n,a)}}function pt(r,t){return function(e,n,a){var o=r[e];if(!Vt(o,n))throw new Error("expected weightMap["+e+"] to be a Tensor"+n+"D, instead have "+o);return t.push({originalPath:e,paramPath:a||e}),o}}function ct(r){var t=r;function e(a){var o=t.slice(0,a);return t=t.slice(a),o}function n(){return t}return{extractWeights:e,getRemainingWeights:n}}function vr(r,t){var e=Yt(r,t),n=de(r,t);function a(c,i,s,u){u===void 0&&(u=!1);var h=u?e(c,i,3,s+"/conv0"):n(c,i,s+"/conv0"),v=n(i,i,s+"/conv1"),f=n(i,i,s+"/conv2");return{conv0:h,conv1:v,conv2:f}}function o(c,i,s,u){u===void 0&&(u=!1);var h=a(c,i,s,u),v=h.conv0,f=h.conv1,l=h.conv2,p=n(i,i,s+"/conv3");return{conv0:v,conv1:f,conv2:l,conv3:p}}return{extractDenseBlock3Params:a,extractDenseBlock4Params:o}}function pn(r){var t=[],e=ct(r),n=e.extractWeights,a=e.getRemainingWeights,o=vr(n,t).extractDenseBlock4Params,c=o(3,32,"dense0",!0),i=o(32,64,"dense1"),s=o(64,128,"dense2"),u=o(128,256,"dense3");if(a().length!==0)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:t,params:{dense0:c,dense1:i,dense2:s,dense3:u}}}function fr(r){return function(t){var e=r(t+"/filters",4),n=r(t+"/bias",1);return{filters:e,bias:n}}}function lr(r,t){var e=pt(r,t),n=fr(e),a=me(e);function o(i,s){s===void 0&&(s=!1);var u=s?n(i+"/conv0"):a(i+"/conv0"),h=a(i+"/conv1"),v=a(i+"/conv2");return{conv0:u,conv1:h,conv2:v}}function c(i,s){s===void 0&&(s=!1);var u=s?n(i+"/conv0"):a(i+"/conv0"),h=a(i+"/conv1"),v=a(i+"/conv2"),f=a(i+"/conv3");return{conv0:u,conv1:h,conv2:v,conv3:f}}return{extractDenseBlock3Params:o,extractDenseBlock4Params:c}}function dn(r){var t=[],e=lr(r,t).extractDenseBlock4Params,n={dense0:e("dense0",!0),dense1:e("dense1"),dense2:e("dense2"),dense3:e("dense3")};return it(r,t),{params:n,paramMappings:t}}var pr=function(r){E(t,r);function t(){return r.call(this,"FaceFeatureExtractor")||this}return t.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("FaceFeatureExtractor - load model before inference");return F(function(){var a=e.toBatchTensor(112,!0),o=[122.782,117.001,104.298],c=Bt(a,o).div(I(255)),i=Nt(c,n.dense0,!0);return i=Nt(i,n.dense1),i=Nt(i,n.dense2),i=Nt(i,n.dense3),i=Ht(i,[7,7],[2,2],"valid"),i})},t.prototype.forward=function(e){return w(this,void 0,void 0,function(){var n;return x(this,function(a){switch(a.label){case 0:return n=this.forwardInput,[4,O(e)];case 1:return[2,n.apply(this,[a.sent()])]}})})},t.prototype.getDefaultModelName=function(){return"face_feature_extractor_model"},t.prototype.extractParamsFromWeigthMap=function(e){return dn(e)},t.prototype.extractParams=function(e){return pn(e)},t}(ot);function Q(r,t){return F(function(){return C(Ze(r,t.weights),t.bias)})}function mn(r,t,e){var n=[],a=ct(r),o=a.extractWeights,c=a.getRemainingWeights,i=pe(o,n),s=i(t,e,"fc");if(c().length!==0)throw new Error("weights remaing after extract: "+c().length);return{paramMappings:n,params:{fc:s}}}function gn(r){var t=[],e=pt(r,t);function n(o){var c=e(o+"/weights",2),i=e(o+"/bias",1);return{weights:c,bias:i}}var a={fc:n("fc")};return it(r,t),{params:a,paramMappings:t}}function dr(r){var t={},e={};return Object.keys(r).forEach(function(n){var a=n.startsWith("fc")?e:t;a[n]=r[n]}),{featureExtractorMap:t,classifierMap:e}}var mr=function(r){E(t,r);function t(e,n){var a=r.call(this,e)||this;return a._faceFeatureExtractor=n,a}return Object.defineProperty(t.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),t.prototype.runNet=function(e){var n=this,a=this.params;if(!a)throw new Error(this._name+" - load model before inference");return F(function(){var o=e instanceof Rt?n.faceFeatureExtractor.forwardInput(e):e;return Q(o.as2D(o.shape[0],-1),a.fc)})},t.prototype.dispose=function(e){e===void 0&&(e=!0),this.faceFeatureExtractor.dispose(e),r.prototype.dispose.call(this,e)},t.prototype.loadClassifierParams=function(e){var n=this.extractClassifierParams(e),a=n.params,o=n.paramMappings;this._params=a,this._paramMappings=o},t.prototype.extractClassifierParams=function(e){return mn(e,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())},t.prototype.extractParamsFromWeigthMap=function(e){var n=dr(e),a=n.featureExtractorMap,o=n.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(a),gn(o)},t.prototype.extractParams=function(e){var n=this.getClassifierChannelsIn(),a=this.getClassifierChannelsOut(),o=a*n+a,c=e.slice(0,e.length-o),i=e.slice(e.length-o);return this.faceFeatureExtractor.extractWeights(c),this.extractClassifierParams(i)},t}(ot),$e=["neutral","happy","sad","angry","fearful","disgusted","surprised"],_n=function(){function r(t){var e=this;if(t.length!==7)throw new Error("FaceExpressions.constructor - expected probabilities.length to be 7, have: "+t.length);$e.forEach(function(n,a){e[n]=t[a]})}return r.prototype.asSortedArray=function(){var t=this;return $e.map(function(e){return{expression:e,probability:t[e]}}).sort(function(e,n){return n.probability-e.probability})},r}(),bn=function(r){E(t,r);function t(e){return e===void 0&&(e=new pr),r.call(this,"FaceExpressionNet",e)||this}return t.prototype.forwardInput=function(e){var n=this;return F(function(){return Dt(n.runNet(e))})},t.prototype.forward=function(e){return w(this,void 0,void 0,function(){var n;return x(this,function(a){switch(a.label){case 0:return n=this.forwardInput,[4,O(e)];case 1:return[2,n.apply(this,[a.sent()])]}})})},t.prototype.predictExpressions=function(e){return w(this,void 0,void 0,function(){var n,a,o,c,i=this;return x(this,function(s){switch(s.label){case 0:return[4,O(e)];case 1:return n=s.sent(),[4,this.forwardInput(n)];case 2:return a=s.sent(),[4,Promise.all(R(a).map(function(u){return w(i,void 0,void 0,function(){var h;return x(this,function(v){switch(v.label){case 0:return[4,u.data()];case 1:return h=v.sent(),u.dispose(),[2,h]}})})}))];case 3:return o=s.sent(),a.dispose(),c=o.map(function(u){return new _n(u)}),[2,n.isBatchInput?c:c[0]]}})})},t.prototype.getDefaultModelName=function(){return"face_expression_model"},t.prototype.getClassifierChannelsIn=function(){return 256},t.prototype.getClassifierChannelsOut=function(){return 7},t}(mr);function gr(r,t){var e={expressions:t};return Object.assign({},r,e)}function yn(r){return an(r)&&r.landmarks instanceof Wt&&r.unshiftedLandmarks instanceof Wt&&r.alignedRect instanceof tt}function ge(r,t){var e=r.detection.box,n=t.shiftBy(e.x,e.y),a=n.align(),o=r.detection.imageDims,c=new tt(r.detection.score,a.rescale(o.reverse()),o),i={landmarks:n,unshiftedLandmarks:t,alignedRect:c};return Object.assign({},r,i)}function wn(r,t){var e=Yt(r,t),n=de(r,t);function a(c,i,s){var u=n(c,i,s+"/separable_conv0"),h=n(i,i,s+"/separable_conv1"),v=e(c,i,1,s+"/expansion_conv");return{separable_conv0:u,separable_conv1:h,expansion_conv:v}}function o(c,i){var s=n(c,c,i+"/separable_conv0"),u=n(c,c,i+"/separable_conv1"),h=n(c,c,i+"/separable_conv2");return{separable_conv0:s,separable_conv1:u,separable_conv2:h}}return{extractConvParams:e,extractSeparableConvParams:n,extractReductionBlockParams:a,extractMainBlockParams:o}}function xn(r,t){var e=[],n=ct(r),a=n.extractWeights,o=n.getRemainingWeights,c=wn(a,e),i=c.extractConvParams,s=c.extractSeparableConvParams,u=c.extractReductionBlockParams,h=c.extractMainBlockParams,v=i(3,32,3,"entry_flow/conv_in"),f=u(32,64,"entry_flow/reduction_block_0"),l=u(64,128,"entry_flow/reduction_block_1"),p={conv_in:v,reduction_block_0:f,reduction_block_1:l},m={};Tt(t,0,1).forEach(function(y){m["main_block_"+y]=h(128,"middle_flow/main_block_"+y)});var g=u(128,256,"exit_flow/reduction_block"),b=s(256,512,"exit_flow/separable_conv"),P={reduction_block:g,separable_conv:b};if(o().length!==0)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:e,params:{entry_flow:p,middle_flow:m,exit_flow:P}}}function Pn(r,t){var e=pt(r,t),n=fr(e),a=me(e);function o(i){var s=a(i+"/separable_conv0"),u=a(i+"/separable_conv1"),h=n(i+"/expansion_conv");return{separable_conv0:s,separable_conv1:u,expansion_conv:h}}function c(i){var s=a(i+"/separable_conv0"),u=a(i+"/separable_conv1"),h=a(i+"/separable_conv2");return{separable_conv0:s,separable_conv1:u,separable_conv2:h}}return{extractConvParams:n,extractSeparableConvParams:a,extractReductionBlockParams:o,extractMainBlockParams:c}}function Fn(r,t){var e=[],n=Pn(r,e),a=n.extractConvParams,o=n.extractSeparableConvParams,c=n.extractReductionBlockParams,i=n.extractMainBlockParams,s=a("entry_flow/conv_in"),u=c("entry_flow/reduction_block_0"),h=c("entry_flow/reduction_block_1"),v={conv_in:s,reduction_block_0:u,reduction_block_1:h},f={};Tt(t,0,1).forEach(function(g){f["main_block_"+g]=i("middle_flow/main_block_"+g)});var l=c("exit_flow/reduction_block"),p=o("exit_flow/separable_conv"),m={reduction_block:l,separable_conv:p};return it(r,e),{params:{entry_flow:v,middle_flow:f,exit_flow:m},paramMappings:e}}function _r(r,t,e){return C(wt(r,t.filters,e,"same"),t.bias)}function re(r,t,e){e===void 0&&(e=!0);var n=e?A(r):r;return n=V(n,t.separable_conv0,[1,1]),n=V(A(n),t.separable_conv1,[1,1]),n=W(n,[3,3],[2,2],"same"),n=C(n,_r(r,t.expansion_conv,[2,2])),n}function En(r,t){var e=V(A(r),t.separable_conv0,[1,1]);return e=V(A(e),t.separable_conv1,[1,1]),e=V(A(e),t.separable_conv2,[1,1]),e=C(e,r),e}var Mn=function(r){E(t,r);function t(e){var n=r.call(this,"TinyXception")||this;return n._numMainBlocks=e,n}return t.prototype.forwardInput=function(e){var n=this,a=this.params;if(!a)throw new Error("TinyXception - load model before inference");return F(function(){var o=e.toBatchTensor(112,!0),c=[122.782,117.001,104.298],i=Bt(o,c).div(I(256)),s=A(_r(i,a.entry_flow.conv_in,[2,2]));return s=re(s,a.entry_flow.reduction_block_0,!1),s=re(s,a.entry_flow.reduction_block_1),Tt(n._numMainBlocks,0,1).forEach(function(u){s=En(s,a.middle_flow["main_block_"+u])}),s=re(s,a.exit_flow.reduction_block),s=A(V(s,a.exit_flow.separable_conv,[1,1])),s})},t.prototype.forward=function(e){return w(this,void 0,void 0,function(){var n;return x(this,function(a){switch(a.label){case 0:return n=this.forwardInput,[4,O(e)];case 1:return[2,n.apply(this,[a.sent()])]}})})},t.prototype.getDefaultModelName=function(){return"tiny_xception_model"},t.prototype.extractParamsFromWeigthMap=function(e){return Fn(e,this._numMainBlocks)},t.prototype.extractParams=function(e){return xn(e,this._numMainBlocks)},t}(ot);function Dn(r){var t=[],e=ct(r),n=e.extractWeights,a=e.getRemainingWeights,o=pe(n,t),c=o(512,1,"fc/age"),i=o(512,2,"fc/gender");if(a().length!==0)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:t,params:{fc:{age:c,gender:i}}}}function Cn(r){var t=[],e=pt(r,t);function n(o){var c=e(o+"/weights",2),i=e(o+"/bias",1);return{weights:c,bias:i}}var a={fc:{age:n("fc/age"),gender:n("fc/gender")}};return it(r,t),{params:a,paramMappings:t}}var jt;(function(r){r.FEMALE="female",r.MALE="male"})(jt||(jt={}));var Tn=function(r){E(t,r);function t(e){e===void 0&&(e=new Mn(2));var n=r.call(this,"AgeGenderNet")||this;return n._faceFeatureExtractor=e,n}return Object.defineProperty(t.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),t.prototype.runNet=function(e){var n=this,a=this.params;if(!a)throw new Error(this._name+" - load model before inference");return F(function(){var o=e instanceof Rt?n.faceFeatureExtractor.forwardInput(e):e,c=Ht(o,[7,7],[2,2],"valid").as2D(o.shape[0],-1),i=Q(c,a.fc.age).as1D(),s=Q(c,a.fc.gender);return{age:i,gender:s}})},t.prototype.forwardInput=function(e){var n=this;return F(function(){var a=n.runNet(e),o=a.age,c=a.gender;return{age:o,gender:Dt(c)}})},t.prototype.forward=function(e){return w(this,void 0,void 0,function(){var n;return x(this,function(a){switch(a.label){case 0:return n=this.forwardInput,[4,O(e)];case 1:return[2,n.apply(this,[a.sent()])]}})})},t.prototype.predictAgeAndGender=function(e){return w(this,void 0,void 0,function(){var n,a,o,c,i,s,u=this;return x(this,function(h){switch(h.label){case 0:return[4,O(e)];case 1:return n=h.sent(),[4,this.forwardInput(n)];case 2:return a=h.sent(),o=R(a.age),c=R(a.gender),i=o.map(function(v,f){return{ageTensor:v,genderTensor:c[f]}}),[4,Promise.all(i.map(function(v){var f=v.ageTensor,l=v.genderTensor;return w(u,void 0,void 0,function(){var p,m,g,b,P;return x(this,function(y){switch(y.label){case 0:return[4,f.data()];case 1:return p=y.sent()[0],[4,l.data()];case 2:return m=y.sent()[0],g=m>.5,b=g?jt.MALE:jt.FEMALE,P=g?m:1-m,f.dispose(),l.dispose(),[2,{age:p,gender:b,genderProbability:P}]}})})}))];case 3:return s=h.sent(),a.age.dispose(),a.gender.dispose(),[2,n.isBatchInput?s:s[0]]}})})},t.prototype.getDefaultModelName=function(){return"age_gender_model"},t.prototype.dispose=function(e){e===void 0&&(e=!0),this.faceFeatureExtractor.dispose(e),r.prototype.dispose.call(this,e)},t.prototype.loadClassifierParams=function(e){var n=this.extractClassifierParams(e),a=n.params,o=n.paramMappings;this._params=a,this._paramMappings=o},t.prototype.extractClassifierParams=function(e){return Dn(e)},t.prototype.extractParamsFromWeigthMap=function(e){var n=dr(e),a=n.featureExtractorMap,o=n.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(a),Cn(o)},t.prototype.extractParams=function(e){var n=1539,a=e.slice(0,e.length-n),o=e.slice(e.length-n);return this.faceFeatureExtractor.extractWeights(a),this.extractClassifierParams(o)},t}(ot),br=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.postProcess=function(e,n,a){var o=a.map(function(i){var s=i.width,u=i.height,h=n/Math.max(u,s);return{width:s*h,height:u*h}}),c=o.length;return F(function(){var i=function(f,l){return Ft([mt([68],f),mt([68],l)],1).as2D(1,136).as1D()},s=function(f,l){var p=o[f],m=p.width,g=p.height;return l(m,g)?Math.abs(m-g)/2:0},u=function(f){return s(f,function(l,p){return l<p})},h=function(f){return s(f,function(l,p){return p<l})},v=e.mul(mt([c,136],n)).sub(Ft(Array.from(Array(c),function(f,l){return i(u(l),h(l))}))).div(Ft(Array.from(Array(c),function(f,l){return i(o[l].width,o[l].height)})));return v})},t.prototype.forwardInput=function(e){var n=this;return F(function(){var a=n.runNet(e);return n.postProcess(a,e.inputSize,e.inputDimensions.map(function(o){var c=o[0],i=o[1];return{height:c,width:i}}))})},t.prototype.forward=function(e){return w(this,void 0,void 0,function(){var n;return x(this,function(a){switch(a.label){case 0:return n=this.forwardInput,[4,O(e)];case 1:return[2,n.apply(this,[a.sent()])]}})})},t.prototype.detectLandmarks=function(e){return w(this,void 0,void 0,function(){var n,a,o,c=this;return x(this,function(i){switch(i.label){case 0:return[4,O(e)];case 1:return n=i.sent(),a=F(function(){return R(c.forwardInput(n))}),[4,Promise.all(a.map(function(s,u){return w(c,void 0,void 0,function(){var h,v,f,l,p;return x(this,function(m){switch(m.label){case 0:return f=(v=Array).from,[4,s.data()];case 1:return h=f.apply(v,[m.sent()]),l=h.filter(function(g,b){return We(b)}),p=h.filter(function(g,b){return!We(b)}),[2,new nn(Array(68).fill(0).map(function(g,b){return new T(l[b],p[b])}),{height:n.getInputHeight(u),width:n.getInputWidth(u)})]}})})}))];case 2:return o=i.sent(),a.forEach(function(s){return s.dispose()}),[2,n.isBatchInput?o:o[0]]}})})},t.prototype.getClassifierChannelsOut=function(){return 136},t}(mr),yr=function(r){E(t,r);function t(e){return e===void 0&&(e=new pr),r.call(this,"FaceLandmark68Net",e)||this}return t.prototype.getDefaultModelName=function(){return"face_landmark_68_model"},t.prototype.getClassifierChannelsIn=function(){return 256},t}(br);function Sn(r){var t=[],e=lr(r,t).extractDenseBlock3Params,n={dense0:e("dense0",!0),dense1:e("dense1"),dense2:e("dense2")};return it(r,t),{params:n,paramMappings:t}}function Bn(r){var t=[],e=ct(r),n=e.extractWeights,a=e.getRemainingWeights,o=vr(n,t).extractDenseBlock3Params,c=o(3,32,"dense0",!0),i=o(32,64,"dense1"),s=o(64,128,"dense2");if(a().length!==0)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:t,params:{dense0:c,dense1:i,dense2:s}}}var An=function(r){E(t,r);function t(){return r.call(this,"TinyFaceFeatureExtractor")||this}return t.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("TinyFaceFeatureExtractor - load model before inference");return F(function(){var a=e.toBatchTensor(112,!0),o=[122.782,117.001,104.298],c=Bt(a,o).div(I(255)),i=ee(c,n.dense0,!0);return i=ee(i,n.dense1),i=ee(i,n.dense2),i=Ht(i,[14,14],[2,2],"valid"),i})},t.prototype.forward=function(e){return w(this,void 0,void 0,function(){var n;return x(this,function(a){switch(a.label){case 0:return n=this.forwardInput,[4,O(e)];case 1:return[2,n.apply(this,[a.sent()])]}})})},t.prototype.getDefaultModelName=function(){return"face_feature_extractor_tiny_model"},t.prototype.extractParamsFromWeigthMap=function(e){return Sn(e)},t.prototype.extractParams=function(e){return Bn(e)},t}(ot),kn=function(r){E(t,r);function t(e){return e===void 0&&(e=new An),r.call(this,"FaceLandmark68TinyNet",e)||this}return t.prototype.getDefaultModelName=function(){return"face_landmark_68_tiny_model"},t.prototype.getClassifierChannelsIn=function(){return 128},t}(br);(function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t})(yr);function Nn(r,t){return C(K(r,t.weights),t.biases)}function _e(r,t,e,n,a){a===void 0&&(a="same");var o=t.conv,c=o.filters,i=o.bias,s=wt(r,c,e,a);return s=C(s,i),s=Nn(s,t.scale),n?A(s):s}function In(r,t){return _e(r,t,[1,1],!0)}function wr(r,t){return _e(r,t,[1,1],!1)}function xr(r,t){return _e(r,t,[2,2],!0,"valid")}function Ln(r,t){function e(i,s,u){var h=r(i),v=h.length/(s*u*u);if(Jr(v))throw new Error("depth has to be an integer: "+v+", weights.length: "+h.length+", numFilters: "+s+", filterSize: "+u);return F(function(){return bt(_t(h,[s,v,u,u]),[2,3,1,0])})}function n(i,s,u,h){var v=e(i,s,u),f=G(r(s));return t.push({paramPath:h+"/filters"},{paramPath:h+"/bias"}),{filters:v,bias:f}}function a(i,s){var u=G(r(i)),h=G(r(i));return t.push({paramPath:s+"/weights"},{paramPath:s+"/biases"}),{weights:u,biases:h}}function o(i,s,u,h){var v=n(i,s,u,h+"/conv"),f=a(s,h+"/scale");return{conv:v,scale:f}}function c(i,s,u,h,v){v===void 0&&(v=!1);var f=o((v?.5:1)*i,s,u,h+"/conv1"),l=o(i,s,u,h+"/conv2");return{conv1:f,conv2:l}}return{extractConvLayerParams:o,extractResidualLayerParams:c}}function On(r){var t=ct(r),e=t.extractWeights,n=t.getRemainingWeights,a=[],o=Ln(e,a),c=o.extractConvLayerParams,i=o.extractResidualLayerParams,s=c(4704,32,7,"conv32_down"),u=i(9216,32,3,"conv32_1"),h=i(9216,32,3,"conv32_2"),v=i(9216,32,3,"conv32_3"),f=i(36864,64,3,"conv64_down",!0),l=i(36864,64,3,"conv64_1"),p=i(36864,64,3,"conv64_2"),m=i(36864,64,3,"conv64_3"),g=i(147456,128,3,"conv128_down",!0),b=i(147456,128,3,"conv128_1"),P=i(147456,128,3,"conv128_2"),y=i(589824,256,3,"conv256_down",!0),d=i(589824,256,3,"conv256_1"),_=i(589824,256,3,"conv256_2"),M=i(589824,256,3,"conv256_down_out"),S=F(function(){return bt(qe(e(256*128),[128,256]),[1,0])});if(a.push({paramPath:"fc"}),n().length!==0)throw new Error("weights remaing after extract: "+n().length);var k={conv32_down:s,conv32_1:u,conv32_2:h,conv32_3:v,conv64_down:f,conv64_1:l,conv64_2:p,conv64_3:m,conv128_down:g,conv128_1:b,conv128_2:P,conv256_down:y,conv256_1:d,conv256_2:_,conv256_down_out:M,fc:S};return{params:k,paramMappings:a}}function Wn(r,t){var e=pt(r,t);function n(c){var i=e(c+"/scale/weights",1),s=e(c+"/scale/biases",1);return{weights:i,biases:s}}function a(c){var i=e(c+"/conv/filters",4),s=e(c+"/conv/bias",1),u=n(c);return{conv:{filters:i,bias:s},scale:u}}function o(c){return{conv1:a(c+"/conv1"),conv2:a(c+"/conv2")}}return{extractConvLayerParams:a,extractResidualLayerParams:o}}function Rn(r){var t=[],e=Wn(r,t),n=e.extractConvLayerParams,a=e.extractResidualLayerParams,o=n("conv32_down"),c=a("conv32_1"),i=a("conv32_2"),s=a("conv32_3"),u=a("conv64_down"),h=a("conv64_1"),v=a("conv64_2"),f=a("conv64_3"),l=a("conv128_down"),p=a("conv128_1"),m=a("conv128_2"),g=a("conv256_down"),b=a("conv256_1"),P=a("conv256_2"),y=a("conv256_down_out"),d=r.fc;if(t.push({originalPath:"fc",paramPath:"fc"}),!Ur(d))throw new Error("expected weightMap[fc] to be a Tensor2D, instead have "+d);var _={conv32_down:o,conv32_1:c,conv32_2:i,conv32_3:s,conv64_down:u,conv64_1:h,conv64_2:v,conv64_3:f,conv128_down:l,conv128_1:p,conv128_2:m,conv256_down:g,conv256_1:b,conv256_2:P,conv256_down_out:y,fc:d};return it(r,t),{params:_,paramMappings:t}}function q(r,t){var e=In(r,t.conv1);return e=wr(e,t.conv2),e=C(e,r),e=A(e),e}function It(r,t){var e=xr(r,t.conv1);e=wr(e,t.conv2);var n=Ht(r,2,2,"valid"),a=Qt(n.shape),o=n.shape[3]!==e.shape[3],c=n.shape[1]!==e.shape[1]||n.shape[2]!==e.shape[2];if(c){var i=Ct(e.shape);i[1]=1;var s=Qt(i);e=nt([e,s],1);var u=Ct(e.shape);u[2]=1;var h=Qt(u);e=nt([e,h],2)}return n=o?nt([n,a],3):n,e=C(n,e),e=A(e),e}var jn=function(r){E(t,r);function t(){return r.call(this,"FaceRecognitionNet")||this}return t.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("FaceRecognitionNet - load model before inference");return F(function(){var a=e.toBatchTensor(150,!0).toFloat(),o=[122.782,117.001,104.298],c=Bt(a,o).div(I(256)),i=xr(c,n.conv32_down);i=W(i,3,2,"valid"),i=q(i,n.conv32_1),i=q(i,n.conv32_2),i=q(i,n.conv32_3),i=It(i,n.conv64_down),i=q(i,n.conv64_1),i=q(i,n.conv64_2),i=q(i,n.conv64_3),i=It(i,n.conv128_down),i=q(i,n.conv128_1),i=q(i,n.conv128_2),i=It(i,n.conv256_down),i=q(i,n.conv256_1),i=q(i,n.conv256_2),i=It(i,n.conv256_down_out);var s=i.mean([1,2]),u=Ze(s,n.fc);return u})},t.prototype.forward=function(e){return w(this,void 0,void 0,function(){var n;return x(this,function(a){switch(a.label){case 0:return n=this.forwardInput,[4,O(e)];case 1:return[2,n.apply(this,[a.sent()])]}})})},t.prototype.computeFaceDescriptor=function(e){return w(this,void 0,void 0,function(){var n,a,o,c=this;return x(this,function(i){switch(i.label){case 0:return[4,O(e)];case 1:return n=i.sent(),a=F(function(){return R(c.forwardInput(n))}),[4,Promise.all(a.map(function(s){return s.data()}))];case 2:return o=i.sent(),a.forEach(function(s){return s.dispose()}),[2,n.isBatchInput?o:o[0]]}})})},t.prototype.getDefaultModelName=function(){return"face_recognition_model"},t.prototype.extractParamsFromWeigthMap=function(e){return Rn(e)},t.prototype.extractParams=function(e){return On(e)},t}(ot);function Pr(r,t){var e={descriptor:t};return Object.assign({},r,e)}function Fr(r,t){var e={age:t};return Object.assign({},r,e)}function Er(r,t,e){var n={gender:t,genderProbability:e};return Object.assign({},r,n)}var Mr=function(){function r(t){var e=t===void 0?{}:t,n=e.minFaceSize,a=e.scaleFactor,o=e.maxNumScales,c=e.scoreThresholds,i=e.scaleSteps;if(this._name="MtcnnOptions",this._minFaceSize=n||20,this._scaleFactor=a||.709,this._maxNumScales=o||10,this._scoreThresholds=c||[.6,.7,.7],this._scaleSteps=i,typeof this._minFaceSize!="number"||this._minFaceSize<0)throw new Error(this._name+" - expected minFaceSize to be a number > 0");if(typeof this._scaleFactor!="number"||this._scaleFactor<=0||this._scaleFactor>=1)throw new Error(this._name+" - expected scaleFactor to be a number between 0 and 1");if(typeof this._maxNumScales!="number"||this._maxNumScales<0)throw new Error(this._name+" - expected maxNumScales to be a number > 0");if(!Array.isArray(this._scoreThresholds)||this._scoreThresholds.length!==3||this._scoreThresholds.some(function(s){return typeof s!="number"}))throw new Error(this._name+" - expected scoreThresholds to be an array of numbers of length 3");if(this._scaleSteps&&(!Array.isArray(this._scaleSteps)||this._scaleSteps.some(function(s){return typeof s!="number"})))throw new Error(this._name+" - expected scaleSteps to be an array of numbers")}return Object.defineProperty(r.prototype,"minFaceSize",{get:function(){return this._minFaceSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scaleFactor",{get:function(){return this._scaleFactor},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"maxNumScales",{get:function(){return this._maxNumScales},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scoreThresholds",{get:function(){return this._scoreThresholds},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scaleSteps",{get:function(){return this._scaleSteps},enumerable:!0,configurable:!0}),r}();function zn(r,t){function e(s,u){var h=_t(r(9*s),[3,3,s,1]),v=G(r(s)),f=G(r(s)),l=G(r(s)),p=G(r(s));return t.push({paramPath:u+"/filters"},{paramPath:u+"/batch_norm_scale"},{paramPath:u+"/batch_norm_offset"},{paramPath:u+"/batch_norm_mean"},{paramPath:u+"/batch_norm_variance"}),{filters:h,batch_norm_scale:v,batch_norm_offset:f,batch_norm_mean:l,batch_norm_variance:p}}function n(s,u,h,v,f){var l=_t(r(s*u*h*h),[h,h,s,u]),p=G(r(u));return t.push({paramPath:v+"/filters"},{paramPath:v+"/"+(f?"batch_norm_offset":"bias")}),{filters:l,bias:p}}function a(s,u,h,v){var f=n(s,u,h,v,!0),l=f.filters,p=f.bias;return{filters:l,batch_norm_offset:p}}function o(s,u,h){var v=e(s,h+"/depthwise_conv"),f=a(s,u,1,h+"/pointwise_conv");return{depthwise_conv:v,pointwise_conv:f}}function c(){var s=a(3,32,3,"mobilenetv1/conv_0"),u=o(32,64,"mobilenetv1/conv_1"),h=o(64,128,"mobilenetv1/conv_2"),v=o(128,128,"mobilenetv1/conv_3"),f=o(128,256,"mobilenetv1/conv_4"),l=o(256,256,"mobilenetv1/conv_5"),p=o(256,512,"mobilenetv1/conv_6"),m=o(512,512,"mobilenetv1/conv_7"),g=o(512,512,"mobilenetv1/conv_8"),b=o(512,512,"mobilenetv1/conv_9"),P=o(512,512,"mobilenetv1/conv_10"),y=o(512,512,"mobilenetv1/conv_11"),d=o(512,1024,"mobilenetv1/conv_12"),_=o(1024,1024,"mobilenetv1/conv_13");return{conv_0:s,conv_1:u,conv_2:h,conv_3:v,conv_4:f,conv_5:l,conv_6:p,conv_7:m,conv_8:g,conv_9:b,conv_10:P,conv_11:y,conv_12:d,conv_13:_}}function i(){var s=a(1024,256,1,"prediction_layer/conv_0"),u=a(256,512,3,"prediction_layer/conv_1"),h=a(512,128,1,"prediction_layer/conv_2"),v=a(128,256,3,"prediction_layer/conv_3"),f=a(256,128,1,"prediction_layer/conv_4"),l=a(128,256,3,"prediction_layer/conv_5"),p=a(256,64,1,"prediction_layer/conv_6"),m=a(64,128,3,"prediction_layer/conv_7"),g=n(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),b=n(512,9,1,"prediction_layer/box_predictor_0/class_predictor"),P=n(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),y=n(1024,18,1,"prediction_layer/box_predictor_1/class_predictor"),d=n(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),_=n(512,18,1,"prediction_layer/box_predictor_2/class_predictor"),M=n(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),S=n(256,18,1,"prediction_layer/box_predictor_3/class_predictor"),k=n(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),B=n(256,18,1,"prediction_layer/box_predictor_4/class_predictor"),D=n(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),L=n(128,18,1,"prediction_layer/box_predictor_5/class_predictor"),z={box_encoding_predictor:g,class_predictor:b},Y={box_encoding_predictor:P,class_predictor:y},U={box_encoding_predictor:d,class_predictor:_},dt={box_encoding_predictor:M,class_predictor:S},xt={box_encoding_predictor:k,class_predictor:B},et={box_encoding_predictor:D,class_predictor:L};return{conv_0:s,conv_1:u,conv_2:h,conv_3:v,conv_4:f,conv_5:l,conv_6:p,conv_7:m,box_predictor_0:z,box_predictor_1:Y,box_predictor_2:U,box_predictor_3:dt,box_predictor_4:xt,box_predictor_5:et}}return{extractMobilenetV1Params:c,extractPredictionLayerParams:i}}function Hn(r){var t=[],e=ct(r),n=e.extractWeights,a=e.getRemainingWeights,o=zn(n,t),c=o.extractMobilenetV1Params,i=o.extractPredictionLayerParams,s=c(),u=i(),h=zr(n(5118*4),[1,5118,4]),v={extra_dim:h};if(t.push({paramPath:"output_layer/extra_dim"}),a().length!==0)throw new Error("weights remaing after extract: "+a().length);return{params:{mobilenetv1:s,prediction_layer:u,output_layer:v},paramMappings:t}}function Gn(r,t){var e=pt(r,t);function n(u,h,v){var f=e(u+"/Conv2d_"+h+"_pointwise/weights",4,v+"/filters"),l=e(u+"/Conv2d_"+h+"_pointwise/convolution_bn_offset",1,v+"/batch_norm_offset");return{filters:f,batch_norm_offset:l}}function a(u){var h="mobilenetv1/conv_"+u,v="MobilenetV1/Conv2d_"+u+"_depthwise",f=h+"/depthwise_conv",l=h+"/pointwise_conv",p=e(v+"/depthwise_weights",4,f+"/filters"),m=e(v+"/BatchNorm/gamma",1,f+"/batch_norm_scale"),g=e(v+"/BatchNorm/beta",1,f+"/batch_norm_offset"),b=e(v+"/BatchNorm/moving_mean",1,f+"/batch_norm_mean"),P=e(v+"/BatchNorm/moving_variance",1,f+"/batch_norm_variance");return{depthwise_conv:{filters:p,batch_norm_scale:m,batch_norm_offset:g,batch_norm_mean:b,batch_norm_variance:P},pointwise_conv:n("MobilenetV1",u,l)}}function o(){return{conv_0:n("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:a(1),conv_2:a(2),conv_3:a(3),conv_4:a(4),conv_5:a(5),conv_6:a(6),conv_7:a(7),conv_8:a(8),conv_9:a(9),conv_10:a(10),conv_11:a(11),conv_12:a(12),conv_13:a(13)}}function c(u,h){var v=e(u+"/weights",4,h+"/filters"),f=e(u+"/biases",1,h+"/bias");return{filters:v,bias:f}}function i(u){var h=c("Prediction/BoxPredictor_"+u+"/BoxEncodingPredictor","prediction_layer/box_predictor_"+u+"/box_encoding_predictor"),v=c("Prediction/BoxPredictor_"+u+"/ClassPredictor","prediction_layer/box_predictor_"+u+"/class_predictor");return{box_encoding_predictor:h,class_predictor:v}}function s(){return{conv_0:n("Prediction",0,"prediction_layer/conv_0"),conv_1:n("Prediction",1,"prediction_layer/conv_1"),conv_2:n("Prediction",2,"prediction_layer/conv_2"),conv_3:n("Prediction",3,"prediction_layer/conv_3"),conv_4:n("Prediction",4,"prediction_layer/conv_4"),conv_5:n("Prediction",5,"prediction_layer/conv_5"),conv_6:n("Prediction",6,"prediction_layer/conv_6"),conv_7:n("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:i(0),box_predictor_1:i(1),box_predictor_2:i(2),box_predictor_3:i(3),box_predictor_4:i(4),box_predictor_5:i(5)}}return{extractMobilenetV1Params:o,extractPredictionLayerParams:s}}function Vn(r){var t=[],e=Gn(r,t),n=e.extractMobilenetV1Params,a=e.extractPredictionLayerParams,o=r["Output/extra_dim"];if(t.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!$t(o))throw new Error("expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have "+o);var c={mobilenetv1:n(),prediction_layer:a(),output_layer:{extra_dim:o}};return it(r,t),{params:c,paramMappings:t}}function Z(r,t,e){return F(function(){var n=wt(r,t.filters,e,"same");return n=C(n,t.batch_norm_offset),Ke(n,0,6)})}var $n=.0010000000474974513;function Un(r,t,e){return F(function(){var n=Hr(r,t.filters,e,"same");return n=Gr(n,t.batch_norm_mean,t.batch_norm_variance,t.batch_norm_offset,t.batch_norm_scale,$n),Ke(n,0,6)})}function Jn(r){return[2,4,6,12].some(function(t){return t===r})?[2,2]:[1,1]}function Yn(r,t){return F(function(){var e=null,n=Z(r,t.conv_0,[2,2]),a=[t.conv_1,t.conv_2,t.conv_3,t.conv_4,t.conv_5,t.conv_6,t.conv_7,t.conv_8,t.conv_9,t.conv_10,t.conv_11,t.conv_12,t.conv_13];if(a.forEach(function(o,c){var i=c+1,s=Jn(i);n=Un(n,o.depthwise_conv,s),n=Z(n,o.pointwise_conv,[1,1]),i===11&&(e=n)}),e===null)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:n,conv11:e}})}function Xn(r,t,e,n,a){var o=r.shape[0],c=Math.min(e,o),i=t.map(function(h,v){return{score:h,boxIndex:v}}).filter(function(h){return h.score>a}).sort(function(h,v){return v.score-h.score}),s=function(h){return h<=n?1:0},u=[];return i.forEach(function(h){if(!(u.length>=c)){for(var v=h.score,f=u.length-1;f>=0;--f){var l=qn(r,h.boxIndex,u[f]);if(l!==0&&(h.score*=s(l),h.score<=a))break}v===h.score&&u.push(h.boxIndex)}}),u}function qn(r,t,e){var n=r.arraySync(),a=Math.min(n[t][0],n[t][2]),o=Math.min(n[t][1],n[t][3]),c=Math.max(n[t][0],n[t][2]),i=Math.max(n[t][1],n[t][3]),s=Math.min(n[e][0],n[e][2]),u=Math.min(n[e][1],n[e][3]),h=Math.max(n[e][0],n[e][2]),v=Math.max(n[e][1],n[e][3]),f=(c-a)*(i-o),l=(h-s)*(v-u);if(f<=0||l<=0)return 0;var p=Math.max(a,s),m=Math.max(o,u),g=Math.min(c,h),b=Math.min(i,v),P=Math.max(g-p,0)*Math.max(b-m,0);return P/(f+l-P)}function Zn(r){var t=R(bt(r,[1,0])),e=[J(t[2],t[0]),J(t[3],t[1])],n=[C(t[0],ht(e[0],I(2))),C(t[1],ht(e[1],I(2)))];return{sizes:e,centers:n}}function Kn(r,t){var e=Zn(r),n=e.sizes,a=e.centers,o=R(bt(t,[1,0])),c=ht(K(Le(ht(o[2],I(5))),n[0]),I(2)),i=C(K(ht(o[0],I(10)),n[0]),a[0]),s=ht(K(Le(ht(o[3],I(5))),n[1]),I(2)),u=C(K(ht(o[1],I(10)),n[1]),a[1]);return bt(Ft([J(i,c),J(u,s),C(i,c),C(u,s)]),[1,0])}function Qn(r,t,e){return F(function(){var n=r.shape[0],a=Kn(vt(Vr(e.extra_dim,[n,1,1]),[-1,4]),vt(r,[-1,4]));a=vt(a,[n,a.shape[0]/n,4]);var o=$r(Ie(t,[0,0,1],[-1,-1,-1])),c=Ie(o,[0,0,0],[-1,-1,1]);c=vt(c,[n,c.shape[1]]);var i=R(a),s=R(c);return{boxes:i,scores:s}})}function Pt(r,t){return F(function(){var e=r.shape[0],n=vt(X(r,t.box_encoding_predictor),[e,-1,1,4]),a=vt(X(r,t.class_predictor),[e,-1,3]);return{boxPredictionEncoding:n,classPrediction:a}})}function ta(r,t,e){return F(function(){var n=Z(r,e.conv_0,[1,1]),a=Z(n,e.conv_1,[2,2]),o=Z(a,e.conv_2,[1,1]),c=Z(o,e.conv_3,[2,2]),i=Z(c,e.conv_4,[1,1]),s=Z(i,e.conv_5,[2,2]),u=Z(s,e.conv_6,[1,1]),h=Z(u,e.conv_7,[2,2]),v=Pt(t,e.box_predictor_0),f=Pt(r,e.box_predictor_1),l=Pt(a,e.box_predictor_2),p=Pt(c,e.box_predictor_3),m=Pt(s,e.box_predictor_4),g=Pt(h,e.box_predictor_5),b=nt([v.boxPredictionEncoding,f.boxPredictionEncoding,l.boxPredictionEncoding,p.boxPredictionEncoding,m.boxPredictionEncoding,g.boxPredictionEncoding],1),P=nt([v.classPrediction,f.classPrediction,l.classPrediction,p.classPrediction,m.classPrediction,g.classPrediction],1);return{boxPredictions:b,classPredictions:P}})}var Xt=function(){function r(t){var e=t===void 0?{}:t,n=e.minConfidence,a=e.maxResults;if(this._name="SsdMobilenetv1Options",this._minConfidence=n||.5,this._maxResults=a||100,typeof this._minConfidence!="number"||this._minConfidence<=0||this._minConfidence>=1)throw new Error(this._name+" - expected minConfidence to be a number between 0 and 1");if(typeof this._maxResults!="number")throw new Error(this._name+" - expected maxResults to be a number")}return Object.defineProperty(r.prototype,"minConfidence",{get:function(){return this._minConfidence},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"maxResults",{get:function(){return this._maxResults},enumerable:!0,configurable:!0}),r}(),Dr=function(r){E(t,r);function t(){return r.call(this,"SsdMobilenetv1")||this}return t.prototype.forwardInput=function(e){var n=this.params;if(!n)throw new Error("SsdMobilenetv1 - load model before inference");return F(function(){var a=e.toBatchTensor(512,!1).toFloat(),o=J(K(a,I(.007843137718737125)),I(1)),c=Yn(o,n.mobilenetv1),i=ta(c.out,c.conv11,n.prediction_layer),s=i.boxPredictions,u=i.classPredictions;return Qn(s,u,n.output_layer)})},t.prototype.forward=function(e){return w(this,void 0,void 0,function(){var n;return x(this,function(a){switch(a.label){case 0:return n=this.forwardInput,[4,O(e)];case 1:return[2,n.apply(this,[a.sent()])]}})})},t.prototype.locateFaces=function(e,n){return n===void 0&&(n={}),w(this,void 0,void 0,function(){var a,o,c,i,s,u,h,v,f,l,p,m,g,b,P,y,d,_,M,S,k;return x(this,function(B){switch(B.label){case 0:return a=new Xt(n),o=a.maxResults,c=a.minConfidence,[4,O(e)];case 1:for(i=B.sent(),s=this.forwardInput(i),u=s.boxes,h=s.scores,v=u[0],f=h[0],l=1;l<u.length;l++)u[l].dispose(),h[l].dispose();return g=(m=Array).from,[4,f.data()];case 2:return p=g.apply(m,[B.sent()]),b=.5,P=Xn(v,p,o,b,c),y=i.getReshapedInputDimensions(0),d=i.inputSize,_=d/y.width,M=d/y.height,S=v.arraySync(),k=P.map(function(D){var L=[Math.max(0,S[D][0]),Math.min(1,S[D][2])].map(function(et){return et*M}),z=L[0],Y=L[1],U=[Math.max(0,S[D][1]),Math.min(1,S[D][3])].map(function(et){return et*_}),dt=U[0],xt=U[1];return new tt(p[D],new se(dt,z,xt-dt,Y-z),{height:i.getInputHeight(0),width:i.getInputWidth(0)})}),v.dispose(),f.dispose(),[2,k]}})})},t.prototype.getDefaultModelName=function(){return"ssd_mobilenetv1_model"},t.prototype.extractParamsFromWeigthMap=function(e){return Vn(e)},t.prototype.extractParams=function(e){return Hn(e)},t}(ot);(function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t})(Dr);var ea=.4,ra=[new T(.738768,.874946),new T(2.42204,2.65704),new T(4.30971,7.04493),new T(10.246,4.59428),new T(12.6868,11.8741)],na=[new T(1.603231,2.094468),new T(6.041143,7.080126),new T(2.882459,3.518061),new T(4.266906,5.178857),new T(9.041765,10.66308)],aa=[117.001,114.697,97.404],oa="tiny_yolov2_model",ia="tiny_yolov2_separable_conv_model",Lt=function(r){return typeof r=="number"};function ca(r){if(!r)throw new Error("invalid config: "+r);if(typeof r.withSeparableConvs!="boolean")throw new Error("config.withSeparableConvs has to be a boolean, have: "+r.withSeparableConvs);if(!Lt(r.iouThreshold)||r.iouThreshold<0||r.iouThreshold>1)throw new Error("config.iouThreshold has to be a number between [0, 1], have: "+r.iouThreshold);if(!Array.isArray(r.classes)||!r.classes.length||!r.classes.every(function(t){return typeof t=="string"}))throw new Error("config.classes has to be an array class names: string[], have: "+JSON.stringify(r.classes));if(!Array.isArray(r.anchors)||!r.anchors.length||!r.anchors.map(function(t){return t||{}}).every(function(t){return Lt(t.x)&&Lt(t.y)}))throw new Error("config.anchors has to be an array of { x: number, y: number }, have: "+JSON.stringify(r.anchors));if(r.meanRgb&&(!Array.isArray(r.meanRgb)||r.meanRgb.length!==3||!r.meanRgb.every(Lt)))throw new Error("config.meanRgb has to be an array of shape [number, number, number], have: "+JSON.stringify(r.meanRgb))}function be(r){return F(function(){var t=K(r,I(.10000000149011612));return C(A(J(r,t)),t)})}function st(r,t){return F(function(){var e=Qe(r,[[0,0],[1,1],[1,1],[0,0]]);return e=wt(e,t.conv.filters,[1,1],"valid"),e=J(e,t.bn.sub),e=K(e,t.bn.truediv),e=C(e,t.conv.bias),be(e)})}function ut(r,t){return F(function(){var e=Qe(r,[[0,0],[1,1],[1,1],[0,0]]);return e=Xe(e,t.depthwise_filter,t.pointwise_filter,[1,1],"valid"),e=C(e,t.bias),be(e)})}function sa(r,t){var e=Yt(r,t);function n(c,i){var s=G(r(c)),u=G(r(c));return t.push({paramPath:i+"/sub"},{paramPath:i+"/truediv"}),{sub:s,truediv:u}}function a(c,i,s){var u=e(c,i,3,s+"/conv"),h=n(i,s+"/bn");return{conv:u,bn:h}}var o=de(r,t);return{extractConvParams:e,extractConvWithBatchNormParams:a,extractSeparableConvParams:o}}function ua(r,t,e,n){var a=ct(r),o=a.extractWeights,c=a.getRemainingWeights,i=[],s=sa(o,i),u=s.extractConvParams,h=s.extractConvWithBatchNormParams,v=s.extractSeparableConvParams,f;if(t.withSeparableConvs){var l=n[0],p=n[1],m=n[2],g=n[3],b=n[4],P=n[5],y=n[6],d=n[7],_=n[8],M=t.isFirstLayerConv2d?u(l,p,3,"conv0"):v(l,p,"conv0"),S=v(p,m,"conv1"),k=v(m,g,"conv2"),B=v(g,b,"conv3"),D=v(b,P,"conv4"),L=v(P,y,"conv5"),z=d?v(y,d,"conv6"):void 0,Y=_?v(d,_,"conv7"):void 0,U=u(_||d||y,5*e,1,"conv8");f={conv0:M,conv1:S,conv2:k,conv3:B,conv4:D,conv5:L,conv6:z,conv7:Y,conv8:U}}else{var l=n[0],p=n[1],m=n[2],g=n[3],b=n[4],P=n[5],y=n[6],d=n[7],_=n[8],M=h(l,p,"conv0"),S=h(p,m,"conv1"),k=h(m,g,"conv2"),B=h(g,b,"conv3"),D=h(b,P,"conv4"),L=h(P,y,"conv5"),z=h(y,d,"conv6"),Y=h(d,_,"conv7"),U=u(_,5*e,1,"conv8");f={conv0:M,conv1:S,conv2:k,conv3:B,conv4:D,conv5:L,conv6:z,conv7:Y,conv8:U}}if(c().length!==0)throw new Error("weights remaing after extract: "+c().length);return{params:f,paramMappings:i}}function ha(r,t){var e=pt(r,t);function n(i){var s=e(i+"/sub",1),u=e(i+"/truediv",1);return{sub:s,truediv:u}}function a(i){var s=e(i+"/filters",4),u=e(i+"/bias",1);return{filters:s,bias:u}}function o(i){var s=a(i+"/conv"),u=n(i+"/bn");return{conv:s,bn:u}}var c=me(e);return{extractConvParams:a,extractConvWithBatchNormParams:o,extractSeparableConvParams:c}}function va(r,t){var e=[],n=ha(r,e),a=n.extractConvParams,o=n.extractConvWithBatchNormParams,c=n.extractSeparableConvParams,i;if(t.withSeparableConvs){var s=t.filterSizes&&t.filterSizes.length||9;i={conv0:t.isFirstLayerConv2d?a("conv0"):c("conv0"),conv1:c("conv1"),conv2:c("conv2"),conv3:c("conv3"),conv4:c("conv4"),conv5:c("conv5"),conv6:s>7?c("conv6"):void 0,conv7:s>8?c("conv7"):void 0,conv8:a("conv8")}}else i={conv0:o("conv0"),conv1:o("conv1"),conv2:o("conv2"),conv3:o("conv3"),conv4:o("conv4"),conv5:o("conv5"),conv6:o("conv6"),conv7:o("conv7"),conv8:a("conv8")};return it(r,e),{params:i,paramMappings:e}}var Ue;(function(r){r[r.XS=224]="XS",r[r.SM=320]="SM",r[r.MD=416]="MD",r[r.LG=608]="LG"})(Ue||(Ue={}));var ye=function(){function r(t){var e=t===void 0?{}:t,n=e.inputSize,a=e.scoreThreshold;if(this._name="TinyYolov2Options",this._inputSize=n||416,this._scoreThreshold=a||.5,typeof this._inputSize!="number"||this._inputSize%32!==0)throw new Error(this._name+" - expected inputSize to be a number divisible by 32");if(typeof this._scoreThreshold!="number"||this._scoreThreshold<=0||this._scoreThreshold>=1)throw new Error(this._name+" - expected scoreThreshold to be a number between 0 and 1")}return Object.defineProperty(r.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scoreThreshold",{get:function(){return this._scoreThreshold},enumerable:!0,configurable:!0}),r}(),Cr=function(r){E(t,r);function t(e){var n=r.call(this,"TinyYolov2")||this;return ca(e),n._config=e,n}return Object.defineProperty(t.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"withClassScores",{get:function(){return this.config.withClassScores||this.config.classes.length>1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"boxEncodingSize",{get:function(){return 5+(this.withClassScores?this.config.classes.length:0)},enumerable:!0,configurable:!0}),t.prototype.runTinyYolov2=function(e,n){var a=st(e,n.conv0);return a=W(a,[2,2],[2,2],"same"),a=st(a,n.conv1),a=W(a,[2,2],[2,2],"same"),a=st(a,n.conv2),a=W(a,[2,2],[2,2],"same"),a=st(a,n.conv3),a=W(a,[2,2],[2,2],"same"),a=st(a,n.conv4),a=W(a,[2,2],[2,2],"same"),a=st(a,n.conv5),a=W(a,[2,2],[1,1],"same"),a=st(a,n.conv6),a=st(a,n.conv7),X(a,n.conv8,"valid",!1)},t.prototype.runMobilenet=function(e,n){var a=this.config.isFirstLayerConv2d?be(X(e,n.conv0,"valid",!1)):ut(e,n.conv0);return a=W(a,[2,2],[2,2],"same"),a=ut(a,n.conv1),a=W(a,[2,2],[2,2],"same"),a=ut(a,n.conv2),a=W(a,[2,2],[2,2],"same"),a=ut(a,n.conv3),a=W(a,[2,2],[2,2],"same"),a=ut(a,n.conv4),a=W(a,[2,2],[2,2],"same"),a=ut(a,n.conv5),a=W(a,[2,2],[1,1],"same"),a=n.conv6?ut(a,n.conv6):a,a=n.conv7?ut(a,n.conv7):a,X(a,n.conv8,"valid",!1)},t.prototype.forwardInput=function(e,n){var a=this,o=this.params;if(!o)throw new Error("TinyYolov2 - load model before inference");return F(function(){var c=e.toBatchTensor(n,!1).toFloat();return c=a.config.meanRgb?Bt(c,a.config.meanRgb):c,c=c.div(I(256)),a.config.withSeparableConvs?a.runMobilenet(c,o):a.runTinyYolov2(c,o)})},t.prototype.forward=function(e,n){return w(this,void 0,void 0,function(){var a;return x(this,function(o){switch(o.label){case 0:return a=this.forwardInput,[4,O(e)];case 1:return[4,a.apply(this,[o.sent(),n])];case 2:return[2,o.sent()]}})})},t.prototype.detect=function(e,n){return n===void 0&&(n={}),w(this,void 0,void 0,function(){var a,o,c,i,s,u,h,v,f,l,p,m,g,b,P=this;return x(this,function(y){switch(y.label){case 0:return a=new ye(n),o=a.inputSize,c=a.scoreThreshold,[4,O(e)];case 1:return i=y.sent(),[4,this.forwardInput(i,o)];case 2:return s=y.sent(),u=F(function(){return R(s)[0].expandDims()}),h={width:i.getInputWidth(0),height:i.getInputHeight(0)},[4,this.extractBoxes(u,i.getReshapedInputDimensions(0),c)];case 3:return v=y.sent(),s.dispose(),u.dispose(),f=v.map(function(d){return d.box}),l=v.map(function(d){return d.score}),p=v.map(function(d){return d.classScore}),m=v.map(function(d){return P.config.classes[d.label]}),g=St(f.map(function(d){return d.rescale(o)}),l,this.config.iouThreshold,!0),b=g.map(function(d){return new tr(l[d],p[d],m[d],f[d],h)}),[2,b]}})})},t.prototype.getDefaultModelName=function(){return""},t.prototype.extractParamsFromWeigthMap=function(e){return va(e,this.config)},t.prototype.extractParams=function(e){var n=this.config.filterSizes||t.DEFAULT_FILTER_SIZES,a=n?n.length:void 0;if(a!==7&&a!==8&&a!==9)throw new Error("TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found "+a+" filterSizes in config");return ua(e,this.config,this.boxEncodingSize,n)},t.prototype.extractBoxes=function(e,n,a){return w(this,void 0,void 0,function(){var o,c,i,s,u,h,v,f,l,p,m,g,b,P,y,d,_,M,S,k,B,D,L,z,Y,U,dt,xt,et,Zt=this;return x(this,function(rt){switch(rt.label){case 0:return o=n.width,c=n.height,i=Math.max(o,c),s=i/o,u=i/c,h=e.shape[1],v=this.config.anchors.length,f=F(function(){var Kt=e.reshape([h,h,v,Zt.boxEncodingSize]),Lr=Kt.slice([0,0,0,0],[h,h,v,4]),Or=Kt.slice([0,0,0,4],[h,h,v,1]),Wr=Zt.withClassScores?Dt(Kt.slice([0,0,0,5],[h,h,v,Zt.config.classes.length]),3):I(0);return[Lr,Or,Wr]}),l=f[0],p=f[1],m=f[2],g=[],[4,p.array()];case 1:return b=rt.sent(),[4,l.array()];case 2:P=rt.sent(),y=0,rt.label=3;case 3:if(!(y<h))return[3,12];d=0,rt.label=4;case 4:if(!(d<h))return[3,11];_=0,rt.label=5;case 5:return _<v?(M=te(b[y][d][_][0]),!a||M>a?(S=(d+te(P[y][d][_][0]))/h*s,k=(y+te(P[y][d][_][1]))/h*u,B=Math.exp(P[y][d][_][2])*this.config.anchors[_].x/h*s,D=Math.exp(P[y][d][_][3])*this.config.anchors[_].y/h*u,L=S-B/2,z=k-D/2,Y={row:y,col:d,anchor:_},this.withClassScores?[4,this.extractPredictedClass(m,Y)]:[3,7]):[3,9]):[3,10];case 6:return et=rt.sent(),[3,8];case 7:et={classScore:1,label:0},rt.label=8;case 8:U=et,dt=U.classScore,xt=U.label,g.push(H({box:new Ut(L,z,L+B,z+D),score:M,classScore:M*dt,label:xt},Y)),rt.label=9;case 9:return _++,[3,5];case 10:return d++,[3,4];case 11:return y++,[3,3];case 12:return l.dispose(),p.dispose(),m.dispose(),[2,g]}})})},t.prototype.extractPredictedClass=function(e,n){return w(this,void 0,void 0,function(){var a,o,c,i;return x(this,function(s){switch(s.label){case 0:return a=n.row,o=n.col,c=n.anchor,[4,e.array()];case 1:return i=s.sent(),[2,Array(this.config.classes.length).fill(0).map(function(u,h){return i[a][o][c][h]}).map(function(u,h){return{classScore:u,label:h}}).reduce(function(u,h){return u.classScore>h.classScore?u:h})]}})})},t.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024],t}(ot),fa=function(r){E(t,r);function t(e){e===void 0&&(e=!0);var n=this,a=Object.assign({},{withSeparableConvs:e,iouThreshold:ea,classes:["face"]},e?{anchors:na,meanRgb:aa}:{anchors:ra,withClassScores:!0});return n=r.call(this,a)||this,n}return Object.defineProperty(t.prototype,"withSeparableConvs",{get:function(){return this.config.withSeparableConvs},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),t.prototype.locateFaces=function(e,n){return w(this,void 0,void 0,function(){var a;return x(this,function(o){switch(o.label){case 0:return[4,this.detect(e,n)];case 1:return a=o.sent(),[2,a.map(function(c){return new tt(c.score,c.relativeBox,{width:c.imageWidth,height:c.imageHeight})})]}})})},t.prototype.getDefaultModelName=function(){return this.withSeparableConvs?ia:oa},t.prototype.extractParamsFromWeigthMap=function(e){return r.prototype.extractParamsFromWeigthMap.call(this,e)},t}(Cr),la=function(r){E(t,r);function t(){var e=r!==null&&r.apply(this,arguments)||this;return e._name="TinyFaceDetectorOptions",e}return t}(ye),At=function(){function r(){}return r.prototype.then=function(t){return w(this,void 0,void 0,function(){var e;return x(this,function(n){switch(n.label){case 0:return e=t,[4,this.run()];case 1:return[2,e.apply(void 0,[n.sent()])]}})})},r.prototype.run=function(){return w(this,void 0,void 0,function(){return x(this,function(t){throw new Error("ComposableTask - run is not implemented")})})},r}();function qt(r,t,e,n,a){return a===void 0&&(a=function(o){var c=o.alignedRect;return c}),w(this,void 0,void 0,function(){var o,c,i,s,u;return x(this,function(h){switch(h.label){case 0:return o=r.map(function(v){return yn(v)?a(v):v.detection}),i=n,i?[3,5]:t instanceof at?[4,le(t,o)]:[3,2];case 1:return s=h.sent(),[3,4];case 2:return[4,fe(t,o)];case 3:s=h.sent(),h.label=4;case 4:i=s,h.label=5;case 5:return c=i,[4,e(c)];case 6:return u=h.sent(),c.forEach(function(v){return v instanceof at&&v.dispose()}),[2,u]}})})}function we(r,t,e,n,a){return w(this,void 0,void 0,function(){var o=this;return x(this,function(c){return[2,qt([r],t,function(i){return w(o,void 0,void 0,function(){return x(this,function(s){return[2,e(i[0])]})})},n,a)]})})}function pa(r){return F(function(){return Ft(R(r,3).reverse(),3)})}var Ot=2,zt=12;function da(r,t){var e=Yt(r,t),n=pe(r,t);function a(u,h){var v=G(r(u));return t.push({paramPath:h}),v}function o(u,h,v){v===void 0&&(v=!1);var f=e(u[0],u[1],3,h+"/conv1"),l=a(u[1],h+"/prelu1_alpha"),p=e(u[1],u[2],3,h+"/conv2"),m=a(u[2],h+"/prelu2_alpha"),g=e(u[2],u[3],v?2:3,h+"/conv3"),b=a(u[3],h+"/prelu3_alpha");return{conv1:f,prelu1_alpha:l,conv2:p,prelu2_alpha:m,conv3:g,prelu3_alpha:b}}function c(){var u=o([3,10,16,32],"pnet"),h=e(32,2,1,"pnet/conv4_1"),v=e(32,4,1,"pnet/conv4_2");return H(H({},u),{conv4_1:h,conv4_2:v})}function i(){var u=o([3,28,48,64],"rnet",!0),h=n(576,128,"rnet/fc1"),v=a(128,"rnet/prelu4_alpha"),f=n(128,2,"rnet/fc2_1"),l=n(128,4,"rnet/fc2_2");return H(H({},u),{fc1:h,prelu4_alpha:v,fc2_1:f,fc2_2:l})}function s(){var u=o([3,32,64,64],"onet"),h=e(64,128,2,"onet/conv4"),v=a(128,"onet/prelu4_alpha"),f=n(1152,256,"onet/fc1"),l=a(256,"onet/prelu5_alpha"),p=n(256,2,"onet/fc2_1"),m=n(256,4,"onet/fc2_2"),g=n(256,10,"onet/fc2_3");return H(H({},u),{conv4:h,prelu4_alpha:v,fc1:f,prelu5_alpha:l,fc2_1:p,fc2_2:m,fc2_3:g})}return{extractPNetParams:c,extractRNetParams:i,extractONetParams:s}}function ma(r){var t=ct(r),e=t.extractWeights,n=t.getRemainingWeights,a=[],o=da(e,a),c=o.extractPNetParams,i=o.extractRNetParams,s=o.extractONetParams,u=c(),h=i(),v=s();if(n().length!==0)throw new Error("weights remaing after extract: "+n().length);return{params:{pnet:u,rnet:h,onet:v},paramMappings:a}}function ga(r,t){var e=pt(r,t);function n(h){var v=e(h+"/weights",4,h+"/filters"),f=e(h+"/bias",1);return{filters:v,bias:f}}function a(h){var v=e(h+"/weights",2),f=e(h+"/bias",1);return{weights:v,bias:f}}function o(h){return e(h,1)}function c(h){var v=n(h+"/conv1"),f=o(h+"/prelu1_alpha"),l=n(h+"/conv2"),p=o(h+"/prelu2_alpha"),m=n(h+"/conv3"),g=o(h+"/prelu3_alpha");return{conv1:v,prelu1_alpha:f,conv2:l,prelu2_alpha:p,conv3:m,prelu3_alpha:g}}function i(){var h=c("pnet"),v=n("pnet/conv4_1"),f=n("pnet/conv4_2");return H(H({},h),{conv4_1:v,conv4_2:f})}function s(){var h=c("rnet"),v=a("rnet/fc1"),f=o("rnet/prelu4_alpha"),l=a("rnet/fc2_1"),p=a("rnet/fc2_2");return H(H({},h),{fc1:v,prelu4_alpha:f,fc2_1:l,fc2_2:p})}function u(){var h=c("onet"),v=n("onet/conv4"),f=o("onet/prelu4_alpha"),l=a("onet/fc1"),p=o("onet/prelu5_alpha"),m=a("onet/fc2_1"),g=a("onet/fc2_2"),b=a("onet/fc2_3");return H(H({},h),{conv4:v,prelu4_alpha:f,fc1:l,prelu5_alpha:p,fc2_1:m,fc2_2:g,fc2_3:b})}return{extractPNetParams:i,extractRNetParams:s,extractONetParams:u}}function _a(r){var t=[],e=ga(r,t),n=e.extractPNetParams,a=e.extractRNetParams,o=e.extractONetParams,c=n(),i=a(),s=o();return it(r,t),{params:{pnet:c,rnet:i,onet:s},paramMappings:t}}function ae(r,t){var e=t[0],n=t[1];return{height:Math.floor(e*r),width:Math.floor(n*r)}}function ba(r,t,e){for(var n=e[0],a=e[1],o=zt/r,c=[],i=Math.min(n,a)*o,s=0;i>=12;)c.push(o*Math.pow(t,s)),i=i*t,s+=1;return c}var xe=function(r){E(t,r);function t(e,n,a,o){return r.call(this,{left:e,top:n,right:a,bottom:o},!0)||this}return t}(lt);function Tr(r){return F(function(){return K(J(r,I(127.5)),I(.0078125))})}function Mt(r,t){return F(function(){return C(A(r),K(t,Oe(A(Oe(r)))))})}function Pe(r,t,e){return e===void 0&&(e=!1),F(function(){var n=X(r,t.conv1,"valid");return n=Mt(n,t.prelu1_alpha),n=W(n,e?[2,2]:[3,3],[2,2],"same"),n=X(n,t.conv2,"valid"),n=Mt(n,t.prelu2_alpha),n=e?n:W(n,[3,3],[2,2],"valid"),n=X(n,t.conv3,"valid"),n=Mt(n,t.prelu3_alpha),n})}function ya(r,t){return F(function(){var e=Pe(r,t,!0),n=X(e,t.conv4_1,"valid"),a=Gt(ie(n,3),3),o=Dt(J(n,a),3),c=X(e,t.conv4_2,"valid");return{prob:o,regions:c}})}function wa(r,t){return F(function(){var e=ae(t,r.shape.slice(1)),n=e.height,a=e.width,o=Je.resizeBilinear(r,[n,a]),c=Tr(o);return bt(c,[0,2,1,3])})}function xa(r,t,e,n){for(var a=[],o=r.arraySync(),c=0;c<r.shape[0];c++)for(var i=0;i<r.shape[1];i++)o[c][i]>=n&&a.push(new T(i,c));var s=a.map(function(u){var h=new Ut(Math.round((u.y*Ot+1)/e),Math.round((u.x*Ot+1)/e),Math.round((u.y*Ot+zt)/e),Math.round((u.x*Ot+zt)/e)),v=o[u.y][u.x],f=t.arraySync(),l=new xe(f[u.y][u.x][0],f[u.y][u.x][1],f[u.y][u.x][2],f[u.y][u.x][3]);return{cell:h,score:v,region:l}});return s}function Pa(r,t,e,n,a){a.stage1=[];var o=t.map(function(f){return F(function(){var l={scale:f},p=wa(r,f),m=Date.now(),g=ya(p,n),b=g.prob,P=g.regions;l.pnet=Date.now()-m;var y=R(R(b,3)[1])[0],d=R(P)[0];return{scoresTensor:y,regionsTensor:d,scale:f,statsForScale:l}})}),c=o.map(function(f){var l=f.scoresTensor,p=f.regionsTensor,m=f.scale,g=f.statsForScale,b=xa(l,p,m,e);if(l.dispose(),p.dispose(),!b.length)return a.stage1.push(g),[];var P=Date.now(),y=St(b.map(function(d){return d.cell}),b.map(function(d){return d.score}),.5);return g.nms=Date.now()-P,g.numBoxes=y.length,a.stage1.push(g),y.map(function(d){return b[d]})}),i=c.reduce(function(f,l){return f.concat(l)},[]),s=[],u=[];if(i.length>0){var h=Date.now(),v=St(i.map(function(f){return f.cell}),i.map(function(f){return f.score}),.7);a.stage1_nms=Date.now()-h,u=v.map(function(f){return i[f].score}),s=v.map(function(f){return i[f]}).map(function(f){var l=f.cell,p=f.region;return new Ut(l.left+p.left*l.width,l.top+p.top*l.height,l.right+p.right*l.width,l.bottom+p.bottom*l.height).toSquare().round()})}return{boxes:s,scores:u}}function Sr(r,t,e){var n=e.width,a=e.height;return w(this,void 0,void 0,function(){var o,c,i,s=this;return x(this,function(u){switch(u.label){case 0:return o=yt(r),[4,Promise.all(t.map(function(h){return w(s,void 0,void 0,function(){var v,f,l,p,m,g,b,P;return x(this,function(y){return v=h.padAtBorders(r.height,r.width),f=v.y,l=v.ey,p=v.x,m=v.ex,g=p-1,b=f-1,P=o.getImageData(g,b,m-g,l-b),[2,j.isNodejs()?ve(P):createImageBitmap(P)]})})}))];case 1:return c=u.sent(),i=[],c.forEach(function(h){var v=Jt({width:n,height:a}),f=yt(v);f.drawImage(h,0,0,n,a);for(var l=f.getImageData(0,0,n,a).data,p=[],m=0;m<l.length;m+=4)p.push(l[m+2]),p.push(l[m+1]),p.push(l[m]);i.push(p)}),[2,i.map(function(h){var v=F(function(){var f=bt(_t(h,[1,n,a,3]),[0,2,1,3]).toFloat();return Tr(f)});return v})]}})})}function Fa(r,t){return F(function(){var e=Pe(r,t),n=vt(e,[e.shape[0],t.fc1.weights.shape[0]]),a=Q(n,t.fc1),o=Mt(a,t.prelu4_alpha),c=Q(o,t.fc2_1),i=Gt(ie(c,1),1),s=Dt(J(c,i),1),u=Q(o,t.fc2_2),h=R(s,1)[1];return{scores:h,regions:u}})}function Ea(r,t,e,n,a){return w(this,void 0,void 0,function(){var o,c,i,s,u,h,v,f,l,p,m,g,b,P;return x(this,function(y){switch(y.label){case 0:return o=Date.now(),[4,Sr(r,t,{width:24,height:24})];case 1:return c=y.sent(),a.stage2_extractImagePatches=Date.now()-o,o=Date.now(),i=c.map(function(d){var _=Fa(d,n);return d.dispose(),_}),a.stage2_rnet=Date.now()-o,s=i.length>1?nt(i.map(function(d){return d.scores})):i[0].scores,v=(h=Array).from,[4,s.data()];case 2:return u=v.apply(h,[y.sent()]),s.dispose(),f=u.map(function(d,_){return{score:d,idx:_}}).filter(function(d){return d.score>e}).map(function(d){var _=d.idx;return _}),l=f.map(function(d){return t[d]}),p=f.map(function(d){return u[d]}),m=[],g=[],l.length>0&&(o=Date.now(),b=St(l,p,.7),a.stage2_nms=Date.now()-o,P=b.map(function(d){var _=i[f[d]].regions.arraySync();return new xe(_[0][0],_[0][1],_[0][2],_[0][3])}),g=b.map(function(d){return p[d]}),m=b.map(function(d,_){return l[d].calibrate(P[_])})),i.forEach(function(d){d.regions.dispose(),d.scores.dispose()}),[2,{boxes:m,scores:g}]}})})}function Ma(r,t){return F(function(){var e=Pe(r,t);e=W(e,[2,2],[2,2],"same"),e=X(e,t.conv4,"valid"),e=Mt(e,t.prelu4_alpha);var n=vt(e,[e.shape[0],t.fc1.weights.shape[0]]),a=Q(n,t.fc1),o=Mt(a,t.prelu5_alpha),c=Q(o,t.fc2_1),i=Gt(ie(c,1),1),s=Dt(J(c,i),1),u=Q(o,t.fc2_2),h=Q(o,t.fc2_3),v=R(s,1)[1];return{scores:v,regions:u,points:h}})}function Da(r,t,e,n,a){return w(this,void 0,void 0,function(){var o,c,i,s,u,h,v,f,l,p,m,g,b,P,y;return x(this,function(d){switch(d.label){case 0:return o=Date.now(),[4,Sr(r,t,{width:48,height:48})];case 1:return c=d.sent(),a.stage3_extractImagePatches=Date.now()-o,o=Date.now(),i=c.map(function(_){var M=Ma(_,n);return _.dispose(),M}),a.stage3_onet=Date.now()-o,s=i.length>1?nt(i.map(function(_){return _.scores})):i[0].scores,v=(h=Array).from,[4,s.data()];case 2:return u=v.apply(h,[d.sent()]),s.dispose(),f=u.map(function(_,M){return{score:_,idx:M}}).filter(function(_){return _.score>e}).map(function(_){var M=_.idx;return M}),l=f.map(function(_){var M=i[_].regions.arraySync();return new xe(M[0][0],M[0][1],M[0][2],M[0][3])}),p=f.map(function(_,M){return t[_].calibrate(l[M])}),m=f.map(function(_){return u[_]}),g=[],b=[],P=[],p.length>0&&(o=Date.now(),y=St(p,m,.7,!1),a.stage3_nms=Date.now()-o,g=y.map(function(_){return p[_]}),b=y.map(function(_){return m[_]}),P=y.map(function(_,M){return Array(5).fill(0).map(function(S,k){var B=i[_].points.arraySync();return new T(B[0][k]*(g[M].width+1)+g[M].left,B[0][k+5]*(g[M].height+1)+g[M].top)})})),i.forEach(function(_){_.regions.dispose(),_.scores.dispose(),_.points.dispose()}),[2,{boxes:g,scores:b,points:P}]}})})}var Ca=function(r){E(t,r);function t(){return r.call(this,"Mtcnn")||this}return t.prototype.load=function(e){return w(this,void 0,void 0,function(){return x(this,function(n){return console.warn("mtcnn is deprecated and will be removed soon"),[2,r.prototype.load.call(this,e)]})})},t.prototype.loadFromDisk=function(e){return w(this,void 0,void 0,function(){return x(this,function(n){return console.warn("mtcnn is deprecated and will be removed soon"),[2,r.prototype.loadFromDisk.call(this,e)]})})},t.prototype.forwardInput=function(e,n){return n===void 0&&(n={}),w(this,void 0,void 0,function(){var a,o,c,i,s,u,h,v,f,l,p,m,g,b,P,y,d,_,M,S,k;return x(this,function(B){switch(B.label){case 0:if(a=this.params,!a)throw new Error("Mtcnn - load model before inference");if(o=e.canvases[0],!o)throw new Error("Mtcnn - inputCanvas is not defined, note that passing tensors into Mtcnn.forwardInput is not supported yet.");return c={},i=Date.now(),s=F(function(){return pa(Gt(oe.fromPixels(o)).toFloat())}),u=function(D){return s.dispose(),c.total=Date.now()-i,D},h=s.shape.slice(1),v=h[0],f=h[1],l=new Mr(n),p=l.minFaceSize,m=l.scaleFactor,g=l.maxNumScales,b=l.scoreThresholds,P=l.scaleSteps,y=(P||ba(p,m,[v,f])).filter(function(D){var L=ae(D,[v,f]);return Math.min(L.width,L.height)>zt}).slice(0,g),c.scales=y,c.pyramid=y.map(function(D){return ae(D,[v,f])}),d=Date.now(),[4,Pa(s,y,b[0],a.pnet,c)];case 1:return _=B.sent(),c.total_stage1=Date.now()-d,_.boxes.length?(c.stage2_numInputBoxes=_.boxes.length,d=Date.now(),[4,Ea(o,_.boxes,b[1],a.rnet,c)]):[2,u({results:[],stats:c})];case 2:return M=B.sent(),c.total_stage2=Date.now()-d,M.boxes.length?(c.stage3_numInputBoxes=M.boxes.length,d=Date.now(),[4,Da(o,M.boxes,b[2],a.onet,c)]):[2,u({results:[],stats:c})];case 3:return S=B.sent(),c.total_stage3=Date.now()-d,k=S.boxes.map(function(D,L){return ge(ue({},new tt(S.scores[L],new se(D.left/f,D.top/v,D.width/f,D.height/v),{height:v,width:f})),new rn(S.points[L].map(function(z){return z.sub(new T(D.left,D.top)).div(new T(D.width,D.height))}),{width:D.width,height:D.height}))}),[2,u({results:k,stats:c})]}})})},t.prototype.forward=function(e,n){return n===void 0&&(n={}),w(this,void 0,void 0,function(){var a;return x(this,function(o){switch(o.label){case 0:return a=this.forwardInput,[4,O(e)];case 1:return[4,a.apply(this,[o.sent(),n])];case 2:return[2,o.sent().results]}})})},t.prototype.forwardWithStats=function(e,n){return n===void 0&&(n={}),w(this,void 0,void 0,function(){var a;return x(this,function(o){switch(o.label){case 0:return a=this.forwardInput,[4,O(e)];case 1:return[2,a.apply(this,[o.sent(),n])]}})})},t.prototype.getDefaultModelName=function(){return"mtcnn_model"},t.prototype.extractParamsFromWeigthMap=function(e){return _a(e)},t.prototype.extractParams=function(e){return ma(e)},t}(ot),Ta=.4,Sa=[new T(1.603231,2.094468),new T(6.041143,7.080126),new T(2.882459,3.518061),new T(4.266906,5.178857),new T(9.041765,10.66308)],Ba=[117.001,114.697,97.404],Aa=function(r){E(t,r);function t(){var e=this,n={withSeparableConvs:!0,iouThreshold:Ta,classes:["face"],anchors:Sa,meanRgb:Ba,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]};return e=r.call(this,n)||this,e}return Object.defineProperty(t.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),t.prototype.locateFaces=function(e,n){return w(this,void 0,void 0,function(){var a;return x(this,function(o){switch(o.label){case 0:return[4,this.detect(e,n)];case 1:return a=o.sent(),[2,a.map(function(c){return new tt(c.score,c.relativeBox,{width:c.imageWidth,height:c.imageHeight})})]}})})},t.prototype.getDefaultModelName=function(){return"tiny_face_detector_model"},t.prototype.extractParamsFromWeigthMap=function(e){return r.prototype.extractParamsFromWeigthMap.call(this,e)},t}(Cr),$={ssdMobilenetv1:new Dr,tinyFaceDetector:new Aa,tinyYolov2:new fa,mtcnn:new Ca,faceLandmark68Net:new yr,faceLandmark68TinyNet:new kn,faceRecognitionNet:new jn,faceExpressionNet:new bn,ageGenderNet:new Tn},ja=function(r){return $.tinyFaceDetector.load(r)},Br=function(r){E(t,r);function t(e,n,a){var o=r.call(this)||this;return o.parentTask=e,o.input=n,o.extractedFaces=a,o}return t}(At),Fe=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.run=function(){return w(this,void 0,void 0,function(){var e,n,a=this;return x(this,function(o){switch(o.label){case 0:return[4,this.parentTask];case 1:return e=o.sent(),[4,qt(e,this.input,function(c){return w(a,void 0,void 0,function(){return x(this,function(i){switch(i.label){case 0:return[4,Promise.all(c.map(function(s){return $.faceExpressionNet.predictExpressions(s)}))];case 1:return[2,i.sent()]}})})},this.extractedFaces)];case 2:return n=o.sent(),[2,e.map(function(c,i){return gr(c,n[i])})]}})})},t.prototype.withAgeAndGender=function(){return new Ce(this,this.input)},t}(Br),Ee=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.run=function(){return w(this,void 0,void 0,function(){var e,n;return x(this,function(a){switch(a.label){case 0:return[4,this.parentTask];case 1:return e=a.sent(),e?[4,we(e,this.input,function(o){return $.faceExpressionNet.predictExpressions(o)},this.extractedFaces)]:[2];case 2:return n=a.sent(),[2,gr(e,n)]}})})},t.prototype.withAgeAndGender=function(){return new Te(this,this.input)},t}(Br),Me=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.withAgeAndGender=function(){return new Se(this,this.input)},t.prototype.withFaceDescriptors=function(){return new Ae(this,this.input)},t}(Fe),De=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.withAgeAndGender=function(){return new Be(this,this.input)},t.prototype.withFaceDescriptor=function(){return new ke(this,this.input)},t}(Ee),Ar=function(r){E(t,r);function t(e,n,a){var o=r.call(this)||this;return o.parentTask=e,o.input=n,o.extractedFaces=a,o}return t}(At),Ce=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.run=function(){return w(this,void 0,void 0,function(){var e,n,a=this;return x(this,function(o){switch(o.label){case 0:return[4,this.parentTask];case 1:return e=o.sent(),[4,qt(e,this.input,function(c){return w(a,void 0,void 0,function(){return x(this,function(i){switch(i.label){case 0:return[4,Promise.all(c.map(function(s){return $.ageGenderNet.predictAgeAndGender(s)}))];case 1:return[2,i.sent()]}})})},this.extractedFaces)];case 2:return n=o.sent(),[2,e.map(function(c,i){var s=n[i],u=s.age,h=s.gender,v=s.genderProbability;return Fr(Er(c,h,v),u)})]}})})},t.prototype.withFaceExpressions=function(){return new Fe(this,this.input)},t}(Ar),Te=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.run=function(){return w(this,void 0,void 0,function(){var e,n,a,o,c;return x(this,function(i){switch(i.label){case 0:return[4,this.parentTask];case 1:return e=i.sent(),e?[4,we(e,this.input,function(s){return $.ageGenderNet.predictAgeAndGender(s)},this.extractedFaces)]:[2];case 2:return n=i.sent(),a=n.age,o=n.gender,c=n.genderProbability,[2,Fr(Er(e,o,c),a)]}})})},t.prototype.withFaceExpressions=function(){return new Ee(this,this.input)},t}(Ar),Se=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.withFaceExpressions=function(){return new Me(this,this.input)},t.prototype.withFaceDescriptors=function(){return new Ae(this,this.input)},t}(Ce),Be=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.withFaceExpressions=function(){return new De(this,this.input)},t.prototype.withFaceDescriptor=function(){return new ke(this,this.input)},t}(Te),kr=function(r){E(t,r);function t(e,n){var a=r.call(this)||this;return a.parentTask=e,a.input=n,a}return t}(At),Ae=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.run=function(){return w(this,void 0,void 0,function(){var e,n;return x(this,function(a){switch(a.label){case 0:return[4,this.parentTask];case 1:return e=a.sent(),[4,qt(e,this.input,function(o){return Promise.all(o.map(function(c){return $.faceRecognitionNet.computeFaceDescriptor(c)}))},null,function(o){return o.landmarks.align(null,{useDlibAlignment:!0})})];case 2:return n=a.sent(),[2,n.map(function(o,c){return Pr(e[c],o)})]}})})},t.prototype.withFaceExpressions=function(){return new Me(this,this.input)},t.prototype.withAgeAndGender=function(){return new Se(this,this.input)},t}(kr),ke=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.run=function(){return w(this,void 0,void 0,function(){var e,n;return x(this,function(a){switch(a.label){case 0:return[4,this.parentTask];case 1:return e=a.sent(),e?[4,we(e,this.input,function(o){return $.faceRecognitionNet.computeFaceDescriptor(o)},null,function(o){return o.landmarks.align(null,{useDlibAlignment:!0})})]:[2];case 2:return n=a.sent(),[2,Pr(e,n)]}})})},t.prototype.withFaceExpressions=function(){return new De(this,this.input)},t.prototype.withAgeAndGender=function(){return new Be(this,this.input)},t}(kr),Nr=function(r){E(t,r);function t(e,n,a){var o=r.call(this)||this;return o.parentTask=e,o.input=n,o.useTinyLandmarkNet=a,o}return Object.defineProperty(t.prototype,"landmarkNet",{get:function(){return this.useTinyLandmarkNet?$.faceLandmark68TinyNet:$.faceLandmark68Net},enumerable:!0,configurable:!0}),t}(At),ka=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.run=function(){return w(this,void 0,void 0,function(){var e,n,a,o,c,i=this;return x(this,function(s){switch(s.label){case 0:return[4,this.parentTask];case 1:return e=s.sent(),n=e.map(function(u){return u.detection}),this.input instanceof at?[4,le(this.input,n)]:[3,3];case 2:return o=s.sent(),[3,5];case 3:return[4,fe(this.input,n)];case 4:o=s.sent(),s.label=5;case 5:return a=o,[4,Promise.all(a.map(function(u){return i.landmarkNet.detectLandmarks(u)}))];case 6:return c=s.sent(),a.forEach(function(u){return u instanceof at&&u.dispose()}),[2,e.map(function(u,h){return ge(u,c[h])})]}})})},t.prototype.withFaceExpressions=function(){return new Me(this,this.input)},t.prototype.withAgeAndGender=function(){return new Se(this,this.input)},t.prototype.withFaceDescriptors=function(){return new Ae(this,this.input)},t}(Nr),Na=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.run=function(){return w(this,void 0,void 0,function(){var e,n,a,o,c;return x(this,function(i){switch(i.label){case 0:return[4,this.parentTask];case 1:return e=i.sent(),e?(n=e.detection,this.input instanceof at?[4,le(this.input,[n])]:[3,3]):[2];case 2:return o=i.sent(),[3,5];case 3:return[4,fe(this.input,[n])];case 4:o=i.sent(),i.label=5;case 5:return a=o,[4,this.landmarkNet.detectLandmarks(a[0])];case 6:return c=i.sent(),a.forEach(function(s){return s instanceof at&&s.dispose()}),[2,ge(e,c)]}})})},t.prototype.withFaceExpressions=function(){return new De(this,this.input)},t.prototype.withAgeAndGender=function(){return new Be(this,this.input)},t.prototype.withFaceDescriptor=function(){return new ke(this,this.input)},t}(Nr),Ir=function(r){E(t,r);function t(e,n){n===void 0&&(n=new Xt);var a=r.call(this)||this;return a.input=e,a.options=n,a}return t}(At),Ia=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.run=function(){return w(this,void 0,void 0,function(){var e,n,a,o;return x(this,function(c){switch(c.label){case 0:return e=this,n=e.input,a=e.options,a instanceof Mr?[4,$.mtcnn.forward(n,a)]:[3,2];case 1:return[2,c.sent().map(function(i){return i.detection})];case 2:if(o=a instanceof la?function(i){return $.tinyFaceDetector.locateFaces(i,a)}:a instanceof Xt?function(i){return $.ssdMobilenetv1.locateFaces(i,a)}:a instanceof ye?function(i){return $.tinyYolov2.locateFaces(i,a)}:null,!o)throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | MtcnnOptions | TinyYolov2Options");return[2,o(n)]}})})},t.prototype.runAndExtendWithFaceDetections=function(){var e=this;return new Promise(function(n){return w(e,void 0,void 0,function(){var a;return x(this,function(o){switch(o.label){case 0:return[4,this.run()];case 1:return a=o.sent(),[2,n(a.map(function(c){return ue({},c)}))]}})})})},t.prototype.withFaceLandmarks=function(e){return e===void 0&&(e=!1),new ka(this.runAndExtendWithFaceDetections(),this.input,e)},t.prototype.withFaceExpressions=function(){return new Fe(this.runAndExtendWithFaceDetections(),this.input)},t.prototype.withAgeAndGender=function(){return new Ce(this.runAndExtendWithFaceDetections(),this.input)},t}(Ir),La=function(r){E(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.run=function(){return w(this,void 0,void 0,function(){var e,n;return x(this,function(a){switch(a.label){case 0:return[4,new Ia(this.input,this.options)];case 1:return e=a.sent(),n=e[0],e.forEach(function(o){o.score>n.score&&(n=o)}),[2,n]}})})},t.prototype.runAndExtendWithFaceDetection=function(){var e=this;return new Promise(function(n){return w(e,void 0,void 0,function(){var a;return x(this,function(o){switch(o.label){case 0:return[4,this.run()];case 1:return a=o.sent(),[2,n(a?ue({},a):void 0)]}})})})},t.prototype.withFaceLandmarks=function(e){return e===void 0&&(e=!1),new Na(this.runAndExtendWithFaceDetection(),this.input,e)},t.prototype.withFaceExpressions=function(){return new Ee(this.runAndExtendWithFaceDetection(),this.input)},t.prototype.withAgeAndGender=function(){return new Te(this.runAndExtendWithFaceDetection(),this.input)},t}(Ir);function za(r,t){return t===void 0&&(t=new Xt),new La(r,t)}function Oa(r,t){if(r.length!==t.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");var e=Array.from(r),n=Array.from(t);return Math.sqrt(e.map(function(a,o){return a-n[o]}).reduce(function(a,o){return a+Math.pow(o,2)},0))}(function(){function r(t,e){e===void 0&&(e=.6),this._distanceThreshold=e;var n=Array.isArray(t)?t:[t];if(!n.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");var a=1,o=function(){return"person "+a++};this._labeledDescriptors=n.map(function(c){if(c instanceof kt)return c;if(c instanceof Float32Array)return new kt(o(),[c]);if(c.descriptor&&c.descriptor instanceof Float32Array)return new kt(o(),[c.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")})}return Object.defineProperty(r.prototype,"labeledDescriptors",{get:function(){return this._labeledDescriptors},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"distanceThreshold",{get:function(){return this._distanceThreshold},enumerable:!0,configurable:!0}),r.prototype.computeMeanDistance=function(t,e){return e.map(function(n){return Oa(n,t)}).reduce(function(n,a){return n+a},0)/(e.length||1)},r.prototype.matchDescriptor=function(t){var e=this;return this.labeledDescriptors.map(function(n){var a=n.descriptors,o=n.label;return new ze(o,e.computeMeanDistance(t,a))}).reduce(function(n,a){return n.distance<a.distance?n:a})},r.prototype.findBestMatch=function(t){var e=this.matchDescriptor(t);return e.distance<this.distanceThreshold?e:new ze("unknown",e.distance)},r.prototype.toJSON=function(){return{distanceThreshold:this.distanceThreshold,labeledDescriptors:this.labeledDescriptors.map(function(t){return t.toJSON()})}},r.fromJSON=function(t){var e=t.labeledDescriptors.map(function(n){return kt.fromJSON(n)});return new r(e,t.distanceThreshold)},r})();export{la as T,za as d,ja as l};
